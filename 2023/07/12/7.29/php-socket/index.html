<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        php socket编程 | 东隅's blog
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/jocker.png"/>
    
    
      <link rel="mask-icon"
            href="/images/jocker.png"
            color=""/>
    
    
    <link rel="stylesheet" type="text/css" href="/css/layout.css"/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href="/" class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/jocker.png" />
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/%E5%AE%89%E5%85%A8">安全</a>
            
              <a class="nav-menu-item" href="/%E5%BC%80%E5%8F%91">开发</a>
            
              <a class="nav-menu-item" href="/%E7%94%9F%E6%B4%BB">生活</a>
            
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">php socket编程</div>
        <div class="post-info">
          
  
    <a href="/tags/php/" class="post-tag">#php</a>
  


          <span class="post-date">2023-07-12</span>
        </div>
      </div>
      <div id="postBody" class="post-content__body--toc">
        <div id="tocAnchor" class="toc-anchor">
          <ol id="toc" class="post-toc">
            
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php-socket%E5%87%BD%E6%95%B0"><span class="toc-text">php socket函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84server"><span class="toc-text">简单的server</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84client"><span class="toc-text">简单的client</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7%EF%BC%9AsocketTool"><span class="toc-text">调试工具：socketTool</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%9E%E6%8E%A5socket"><span class="toc-text">浏览器连接socket</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#websocket01-php"><span class="toc-text">websocket01.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#websocket02-php"><span class="toc-text">websocket02.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#websocket03-php"><span class="toc-text">websocket03.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#websocket04-php"><span class="toc-text">websocket04.php</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#websocket05-php"><span class="toc-text">websocket05.php</span></a></li></ol></li></ol>
            
          </ol>
        </div>
        
          <div class="post-gallery">
            
          </div>
        
        <p>[TOC]</p>
<h1 id="php-socket函数"><a href="#php-socket函数" class="headerlink" title="php socket函数"></a>php socket函数</h1><p><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/ref.sockets.php">https://www.php.net/manual/zh/ref.sockets.php</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-accept.php">socket_accept</a> — 接受套接字上的连接</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-addrinfo-bind.php">socket_addrinfo_bind</a> — 从给定的 addrinfo 创建并绑定一个套接字</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-addrinfo-connect.php">socket_addrinfo_connect</a> — 指定 addrinfo 创建并连接套接字</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-addrinfo-explain.php">socket_addrinfo_explain</a> — 获取有关 addrinfo 的信息</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-addrinfo-lookup.php">socket_addrinfo_lookup</a> — 获取数组，包含有关给定主机名的 getaddrinfo 内容</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-bind.php">socket_bind</a> — 给套接字绑定名字</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-clear-error.php">socket_clear_error</a> — 清除套接字或者最后的错误代码上的错误</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-close.php">socket_close</a> — 关闭 Socket 实例</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-cmsg-space.php">socket_cmsg_space</a> — Calculate message buffer size</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-connect.php">socket_connect</a> — 开启一个套接字连接</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-create-listen.php">socket_create_listen</a> — 在端口上打开一个套接字以接受连接</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-create-pair.php">socket_create_pair</a> — 创建一对彼此连接的套接字，并用数组存储</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-create.php">socket_create</a> — 创建一个套接字（通讯节点）</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-export-stream.php">socket_export_stream</a> — Export a socket into a stream that encapsulates a socket</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-get-option.php">socket_get_option</a> — 获取套接字的套接字选项</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-getopt.php">socket_getopt</a> — 别名 socket_get_option</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-getpeername.php">socket_getpeername</a> — 获取套接字远端名字，返回主机名和端口号或是 Unix 文件系统路径，具体取决于套接字类型</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-getsockname.php">socket_getsockname</a> — 获取套接字本地端的名字，返回主机名和端口号或是 Unix 文件系统路径，具体取决于套接字类型</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-import-stream.php">socket_import_stream</a> — 导入 stream</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-last-error.php">socket_last_error</a> — 返回套接字上的最后一个错误</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-listen.php">socket_listen</a> — 监听套接字的连接</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-read.php">socket_read</a> — 从套接字中读取最大长度的数据</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-recv.php">socket_recv</a> — 从已连接的 socket 接收数据</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-recvfrom.php">socket_recvfrom</a> — 从套接字接收数据，无论它是否是面向连接的</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-recvmsg.php">socket_recvmsg</a> — Read a message</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-select.php">socket_select</a> — 从给定套接字数组运行带指定超时时间的 select() 系统调用</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-send.php">socket_send</a> — 向已连接的套接字发送数据</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-sendmsg.php">socket_sendmsg</a> — Send a message</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-sendto.php">socket_sendto</a> — 向套接字发送消息，无论它是否已建立连接</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-set-block.php">socket_set_block</a> — 设置套接字为阻塞模式</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-set-nonblock.php">socket_set_nonblock</a> — 设置套接字为非阻塞模式</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-set-option.php">socket_set_option</a> — 为套接字设置套接字选项</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-setopt.php">socket_setopt</a> — 别名 socket_set_option</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-shutdown.php">socket_shutdown</a> — 关闭套接字接收或发送，或两者都关闭</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-strerror.php">socket_strerror</a> — 返回描述套接字错误的字符串</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-write.php">socket_write</a> — 向套接字写数据</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-wsaprotocol-info-export.php">socket_wsaprotocol_info_export</a> — 导出 WSAPROTOCOL_INFO 结构体</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-wsaprotocol-info-import.php">socket_wsaprotocol_info_import</a> — 从另一个进程导入套接字</li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/function.socket-wsaprotocol-info-release.php">socket_wsaprotocol_info_release</a> — 释放已导出的 WSAPROTOCOL_INFO 结构体</li>
</ul>
<h1 id="简单的server"><a href="#简单的server" class="headerlink" title="简单的server"></a>简单的server</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">netstat -an|grep 6001</span><br><span class="line">telnet 127.0.0.1 6001</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET,SOCK_STREAM,SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>,<span class="string">&#x27;0.0.0.0&#x27;</span>,<span class="number">6001</span>); <span class="comment">//想让局域网内其他主机连接到该socket，监听ip为0.0.0.0即可</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket2 负责处理通信（接收、发送）</span></span><br><span class="line"><span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取客户端发送的数据</span></span><br><span class="line"><span class="variable">$res</span>=socket_read(<span class="variable">$socket2</span>,<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$res</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">socket_write(<span class="variable">$socket2</span>,<span class="string">&#x27;hello client&#x27;</span>);</span><br><span class="line"></span><br><span class="line">socket_close(<span class="variable">$socket2</span>);</span><br><span class="line">socket_close(<span class="variable">$socket1</span>);</span><br></pre></td></tr></table></figure>





<h1 id="简单的client"><a href="#简单的client" class="headerlink" title="简单的client"></a>简单的client</h1><p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151216965.webp" alt="image-20230715121637803"></p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151216668.webp" alt="image-20230715121616175"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$host</span> = <span class="string">&#x27;127.0.0.1&#x27;</span>;</span><br><span class="line"><span class="comment">//$host=&#x27;192.168.0.102&#x27;; //SocketTool</span></span><br><span class="line"><span class="variable">$port</span> = <span class="number">6001</span>;</span><br><span class="line"><span class="variable">$sock</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$sock</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP)) &#123; <span class="comment">//创建socket</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;socket_create() failed ,reason:&quot;</span> .</span><br><span class="line">        socket_strerror(socket_last_error()) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$con</span> = socket_connect(<span class="variable">$sock</span>, <span class="variable">$host</span>, <span class="variable">$port</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;connect fail&#x27;</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;connect success&#x27;</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$message</span> = <span class="string">&quot;hello server&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (socket_write(<span class="variable">$sock</span>, <span class="variable">$message</span>, strlen(<span class="variable">$message</span>)) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;fail to write&#x27;</span> . socket_strerror(socket_last_error());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;client write success&#x27;</span> . PHP_EOL . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="comment">//读取服务端返回来的套接流信息</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="variable">$serverback</span> = socket_read(<span class="variable">$sock</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;server return message is&#x27;</span> . PHP_EOL . <span class="variable">$serverback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="调试工具：socketTool"><a href="#调试工具：socketTool" class="headerlink" title="调试工具：socketTool"></a>调试工具：socketTool</h1><p>服务端测试</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151221409.webp" alt="image-20230715122100934"></p>
<p>客户端测试</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151222298.webp" alt="image-20230715122227011"></p>
<h1 id="浏览器连接socket"><a href="#浏览器连接socket" class="headerlink" title="浏览器连接socket"></a>浏览器连接socket</h1><p>浏览器控制台：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws=<span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://192.168.0.102:6001&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>浏览器结果</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151228280.webp" alt="image-20230715122824075"></p>
<p>服务端结果</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151228592.webp" alt="image-20230715122845275"></p>
<p>这是因为服务端没有成功进行握手，我们需要对服务端代码进行改造</p>
<h2 id="websocket01-php"><a href="#websocket01-php" class="headerlink" title="websocket01.php"></a>websocket01.php</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET,SOCK_STREAM,SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>,<span class="string">&#x27;0.0.0.0&#x27;</span>,<span class="number">6002</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket2 负责处理通信（接收、发送）</span></span><br><span class="line"><span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取客户端发送的数据</span></span><br><span class="line"><span class="variable">$res</span>=socket_read(<span class="variable">$socket2</span>,<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$res</span>.PHP_EOL;</span><br><span class="line">handshake(<span class="variable">$res</span>,<span class="variable">$socket2</span>);</span><br><span class="line">socket_write(<span class="variable">$socket2</span>,encode(<span class="string">&#x27;hello client&#x27;</span>));</span><br><span class="line"></span><br><span class="line">socket_close(<span class="variable">$socket2</span>);</span><br><span class="line">socket_close(<span class="variable">$socket1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//websocket握手处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handshake</span>(<span class="params"><span class="variable">$buffer</span>,<span class="variable">$client_socket</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//截取Sec-WebSocket-Key的值并加密</span></span><br><span class="line">    <span class="variable">$temp_str</span>=substr(<span class="variable">$buffer</span>,strpos(<span class="variable">$buffer</span>,<span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>)+<span class="number">18</span>);</span><br><span class="line">    <span class="variable">$client_key</span>=trim(substr(<span class="variable">$temp_str</span>,<span class="number">0</span>,strpos(<span class="variable">$temp_str</span>,<span class="string">&quot;\r\n&quot;</span>)));</span><br><span class="line">    <span class="variable">$server_key</span>=base64_encode(sha1(<span class="variable">$client_key</span>.<span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>,<span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;client_key[&#x27;</span>.<span class="variable">$client_key</span>.<span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;server_key[&#x27;</span>.<span class="variable">$server_key</span>.<span class="string">&quot;]\n\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是响应包内容，浏览器会进行验证，成功后会建立连接</span></span><br><span class="line">    <span class="variable">$handshake_msg</span>=<span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span>.=<span class="string">&quot;Upgrade:websocket\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span>.=<span class="string">&quot;Sec-WebSocket-Version: 13\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span>.=<span class="string">&quot;Connection: Upgrade\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span>.=<span class="string">&quot;Sec-WebSocket-Accept: &quot;</span>.<span class="variable">$server_key</span>.<span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line">    socket_write(<span class="variable">$client_socket</span>,<span class="variable">$handshake_msg</span>,strlen(<span class="variable">$handshake_msg</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$handshake_msg</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//数据帧处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$len</span>=strlen(<span class="variable">$buffer</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$len</span>&lt;=<span class="number">125</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x81&quot;</span>.chr(<span class="variable">$len</span>).<span class="variable">$buffer</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$len</span>&lt;=<span class="number">65535</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;\x81&quot;</span>.chr(<span class="number">126</span>).pack(<span class="string">&quot;n&quot;</span>,<span class="variable">$len</span>).<span class="variable">$buffer</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="string">&quot;\x81&quot;</span>.chr(<span class="number">127</span>).pack(<span class="string">&quot;xxxxN&quot;</span>,<span class="variable">$len</span>).<span class="variable">$buffer</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//数据帧处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)  </span>&#123;</span><br><span class="line">    <span class="variable">$len</span> = <span class="variable">$masks</span> = <span class="variable">$data</span> = <span class="variable">$decoded</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$len</span> = ord(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>)  &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>)  &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$index</span> = <span class="number">0</span>; <span class="variable">$index</span> &lt; strlen(<span class="variable">$data</span>); <span class="variable">$index</span>++) &#123;</span><br><span class="line">        <span class="variable">$decoded</span> .= <span class="variable">$data</span>[<span class="variable">$index</span>] ^ <span class="variable">$masks</span>[<span class="variable">$index</span> % <span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$decoded</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>再浏览器输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws=new WebSocket(&#x27;ws://192.168.0.102:6002&#x27;);</span><br></pre></td></tr></table></figure>

<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151303243.webp" alt="image-20230715130307957"></p>
<p>这个时候没有报错了，说明浏览器已经校验通过了服务端发来的信息</p>
<p>这里的问题是==服务器并没有保持监听而是断开了连接，我们需要再次修改服务端代码==</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307151305984.webp" alt="image-20230715130546478"></p>
<h2 id="websocket02-php"><a href="#websocket02-php" class="headerlink" title="websocket02.php"></a>websocket02.php</h2><p>这个版本的服务端主要是解决了==持久连接的问题和多用户连接的问题==，注意这个版本不适配浏览器（搞定了持久化连接和诸多问题以后再去改成适配浏览器的版本）</p>
<p>建议debug看一下代码执行流程</p>
<p>注意这个<code>socket_select($read, $write, $except, null)</code>，三个变量只有$read不是null，他只会监测$read，一旦$read里面的套接字有发生了变化的就进入if，并且让$read只剩下发生了变化的套接字，而我们的第二个if <code>in_array($socket1, $read)</code>就限定了只监测接收我们的$socket1</p>
<p>如果<code>socket_select($read, $write, $except, null)</code>没有监测到$read发生变化，就进入处理消息的那端代码了，就是说<code>if (socket_select($read, $write, $except, null) &gt; 0)</code>这段代码是管建立连接的，<code>if (count($read) &gt; 0)</code>这段代码是管处理消息的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6003</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$clients</span> = <span class="keyword">array</span>(<span class="variable">$socket1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">//socket_select对读写套接字的数字是引用，为了保证clients不被改变，拷贝一份</span></span><br><span class="line">    <span class="variable">$read</span> = <span class="variable">$clients</span>;</span><br><span class="line">    <span class="variable">$write</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$except</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*当read发生变化，说明：有客户端进行连接操作了，</span></span><br><span class="line"><span class="comment">    $writr和$except均为null，所以只检测read数组的变化</span></span><br><span class="line"><span class="comment">    socket_select的第四个参数null,表示阻塞，它会阻塞一直到发生变化，</span></span><br><span class="line"><span class="comment">                    0，表示为非阻塞，调用socket_select()后，立即返回，然后继续调用socket_select()不断循环</span></span><br><span class="line"><span class="comment">    返回值是修改后的数组中包含套接字资源的数量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (socket_select(<span class="variable">$read</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$socket1</span>, <span class="variable">$read</span>)) &#123;</span><br><span class="line">            <span class="comment">//socket2负责处理通信（接收、发送）</span></span><br><span class="line">            <span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line">            <span class="variable">$clients</span>[] = <span class="variable">$socket2</span>;</span><br><span class="line">            socket_write(<span class="variable">$socket2</span>, <span class="string">&#x27;You are&#x27;</span> . (count(<span class="variable">$clients</span>) - <span class="number">1</span>) . <span class="string">&quot;clients connect\r\n&quot;</span>);</span><br><span class="line">            socket_getpeername(<span class="variable">$socket2</span>, <span class="variable">$ip</span>, <span class="variable">$port</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\nnew client[&quot;</span> . <span class="variable">$ip</span> . <span class="string">&quot;:&quot;</span> . <span class="variable">$port</span> . <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">            <span class="variable">$key</span> = array_search(<span class="variable">$socket1</span>, <span class="variable">$read</span>);</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$read</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$read</span> <span class="keyword">as</span> <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                <span class="comment">//读取客户端发来的数据</span></span><br><span class="line">                <span class="variable">$msg</span> = socket_read(<span class="variable">$socket_item</span>, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//发给自己：$socket_item</span></span><br><span class="line">                socket_write(<span class="variable">$socket_item</span>, <span class="string">&#x27;received&#x27;</span> . <span class="variable">$msg</span>);</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$clients</span> <span class="keyword">as</span> <span class="variable">$client_socket</span>) &#123;</span><br><span class="line">                    <span class="comment">//发给别人（除去监听和自己）</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$client_socket</span> != <span class="variable">$socket1</span> &amp;&amp; <span class="variable">$client_socket</span> != <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                        sleep(<span class="number">1</span>);</span><br><span class="line">                        socket_write(<span class="variable">$client_socket</span>, <span class="variable">$msg</span>, strlen(<span class="variable">$msg</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307152208472.webp" alt="image-20230715220850020"></p>
<p>这个服务端可以持久连接，但是还有一个新的问题，就是==有连接退出时我们没有进行处理，导致它会一直尝试连接==</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307152212350.webp" alt="image-20230715221254097"></p>
<h2 id="websocket03-php"><a href="#websocket03-php" class="headerlink" title="websocket03.php"></a>websocket03.php</h2><p>前面说上个版本的代码有连接退出时我们没有进行处理，导致它会一直尝试连接</p>
<p>这个版本完成==监测客户端断开并处理==</p>
<p>它做的事情就是给每次写数据都加了if，如果判断不通过就把这次不通过的套接字在数组里删掉</p>
<p><code>if (socket_select($read, $write, $except, null) &gt; 0)</code>这段代码没变，<code>if (count($read) &gt; 0)</code>这段代码的foreach里面加了三个if</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6004</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$clients</span> = <span class="keyword">array</span>(<span class="variable">$socket1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">//socket_select对读写套接字的数字是引用，为了保证clients不被改变，拷贝一份</span></span><br><span class="line">    <span class="variable">$read</span> = <span class="variable">$clients</span>;</span><br><span class="line">    <span class="variable">$write</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$except</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*当read发生变化，说明：有客户端进行连接操作了，</span></span><br><span class="line"><span class="comment">    $write和$except均为null，所以只检测read数组的变化</span></span><br><span class="line"><span class="comment">    socket_select的第四个参数null,表示阻塞，它会阻塞一直到发生变化，</span></span><br><span class="line"><span class="comment">                    0，表示为非阻塞，调用socket_select()后，立即返回，然后继续调用socket_select()不断循环</span></span><br><span class="line"><span class="comment">    返回值是修改后的数组中包含套接字资源的数量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (socket_select(<span class="variable">$read</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*socket_select 接受三个套接字数组，分别检查数组中的套接字是否处于可以操作的状态(返回时只保留可操作的套接字)</span></span><br><span class="line"><span class="comment">        使用最多的是 $read，因此以读为例,在套接字数组 $read 中最初应保有一个服务端监听套接字,每当该套接字可读时，就表示有一个用户发起了连接。此时你需要对该连接创建一个套接字，并加入到 $read 数组中</span></span><br><span class="line"><span class="comment">        当然，并不只是服务端监听的套接字会变成可读的，用户套接字也会变成可读的，此时你就可以读取用户发来的数据了</span></span><br><span class="line"><span class="comment">        socket_select 只在套接字数组发生了变化时才返回。也就是说，一旦执行到 socket_select 的下一条语句，则必有一个套接字是需要你操作的*/</span></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$socket1</span>, <span class="variable">$read</span>)) &#123;</span><br><span class="line">            <span class="comment">//socket2负责处理通信（接收、发送）</span></span><br><span class="line">            <span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line">            <span class="variable">$clients</span>[] = <span class="variable">$socket2</span>;</span><br><span class="line">            socket_write(<span class="variable">$socket2</span>, <span class="string">&#x27;You are  &#x27;</span> . (count(<span class="variable">$clients</span>) - <span class="number">1</span>) . <span class="string">&quot;  clients connect\r\n&quot;</span>);</span><br><span class="line">            socket_getpeername(<span class="variable">$socket2</span>, <span class="variable">$ip</span>, <span class="variable">$port</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\nnew client[&quot;</span> . <span class="variable">$ip</span> . <span class="string">&quot;:&quot;</span> . <span class="variable">$port</span> . <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">            <span class="variable">$key</span> = array_search(<span class="variable">$socket1</span>, <span class="variable">$read</span>);</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$read</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$read</span> <span class="keyword">as</span> <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                <span class="comment">//读取客户端发来的数据</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$msg</span> = @socket_read(<span class="variable">$socket_item</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                    <span class="variable">$key</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;READ ERROR client <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">//发给自己：$socket_item</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$socket_item</span>, <span class="string">&#x27;I post : &#x27;</span> . <span class="variable">$msg</span>)) &#123;</span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                    <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                    <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;MYclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$clients</span> <span class="keyword">as</span> <span class="variable">$client_socket</span>) &#123;</span><br><span class="line">                    <span class="comment">//发给别人（除去监听和自己）</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$client_socket</span> != <span class="variable">$socket1</span> &amp;&amp; <span class="variable">$client_socket</span> != <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                        sleep(<span class="number">1</span>);</span><br><span class="line">                        <span class="comment">//socket_write($client_socket, $msg, strlen($msg));</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$client_socket</span>, <span class="variable">$msg</span>, strlen(<span class="variable">$msg</span>))) &#123;</span><br><span class="line">                            socket_close(<span class="variable">$client_socket</span>);</span><br><span class="line">                            <span class="variable">$key1</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$read</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                            <span class="variable">$key2</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$clients</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&quot;otherclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是可以看到这种判断方法并不优雅，实际上有更好的解决方法</p>
<h2 id="websocket04-php"><a href="#websocket04-php" class="headerlink" title="websocket04.php"></a>websocket04.php</h2><p>socket_recv</p>
<p><code>socket_recv()</code> 函数用于从一个已连接的 socket收数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket_recv(<span class="variable">$socket</span>, &amp;<span class="variable">$buf</span>, $, <span class="variable">$flags</span>);</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li><code>$socket</code>: 已连接的 socket 资源。</li>
<li><code>&amp;$buf</code>: 接收到的数据将存储在该变量中。</li>
<li><code>$len</code>: 期望接收的数据的最大字节数。</li>
<li><code>$flags</code>：可选参数，用于指定接收操作的一些特殊选项。</li>
</ul>
<p>返回值：</p>
<ul>
<li>成功时，返回接收到的数据的字节数。</li>
<li>失败时，返回 false，并且可以通过调用 <code>socket_last_error()</code> 函数获取错误码。</li>
</ul>
<p>示例代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$socket</span>=socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line"><span class="comment">// 将 $socket 连接到服务器</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$buf</span> = <span class="string">&quot;&quot;</span>; <span class="comment">// 存储接收到的数据</span></span><br><span class="line"><span class="variable">$len</span> = <span class="number">1024</span>; <span class="comment">// 最大字节数</span></span><br><span class="line"><span class="variable">$flags</span> = <span class="number">0</span>; <span class="comment">// 没有特殊选项</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$bytesReceived</span> = socket_recv(<span class="variable">$socket</span>, <span class="variable">$buf</span>, <span class="variable">$len</span>, <span class="variable">$flags</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$bytesReceived</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;接收数据失败: &quot;</span> . socket_strerror(socket_last_error()) . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;接收到的数据: &quot;</span> . <span class="variable">$buf</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;接收到的字节数：&quot;</span> . <span class="variable">$bytesReceived</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">socket_close(<span class="variable">$socket</span>);</span><br></pre></td></tr></table></figure>

<p>请注意，在使用 <code>之前，你需要先创建一个已连接的 socket，并且通过 </code>socket_connect()` 函数将其与远程服务器连接起来。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6005</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$clients</span> = <span class="keyword">array</span>(<span class="variable">$socket1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">//socket_select对读写套接字的数字是引用，为了保证clients不被改变，拷贝一份</span></span><br><span class="line">    <span class="variable">$read</span> = <span class="variable">$clients</span>;</span><br><span class="line">    <span class="variable">$write</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$except</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*当read发生变化，说明：有客户端进行连接操作了，</span></span><br><span class="line"><span class="comment">    $write和$except均为null，所以只检测read数组的变化</span></span><br><span class="line"><span class="comment">    socket_select的第四个参数null,表示阻塞，它会阻塞一直到发生变化，</span></span><br><span class="line"><span class="comment">                    0，表示为非阻塞，调用socket_select()后，立即返回，然后继续调用socket_select()不断循环</span></span><br><span class="line"><span class="comment">    返回值是修改后的数组中包含套接字资源的数量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (socket_select(<span class="variable">$read</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*socket_select 接受三个套接字数组，分别检查数组中的套接字是否处于可以操作的状态(返回时只保留可操作的套接字)</span></span><br><span class="line"><span class="comment">        使用最多的是 $read，因此以读为例,在套接字数组 $read 中最初应保有一个服务端监听套接字,每当该套接字可读时，就表示有一个用户发起了连接。此时你需要对该连接创建一个套接字，并加入到 $read 数组中</span></span><br><span class="line"><span class="comment">        当然，并不只是服务端监听的套接字会变成可读的，用户套接字也会变成可读的，此时你就可以读取用户发来的数据了</span></span><br><span class="line"><span class="comment">        socket_select 只在套接字数组发生了变化时才返回。也就是说，一旦执行到 socket_select 的下一条语句，则必有一个套接字是需要你操作的*/</span></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$socket1</span>, <span class="variable">$read</span>)) &#123;</span><br><span class="line">            <span class="comment">//socket2负责处理通信（接收、发送）</span></span><br><span class="line">            <span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line">            <span class="variable">$clients</span>[] = <span class="variable">$socket2</span>;</span><br><span class="line">            socket_write(<span class="variable">$socket2</span>, <span class="string">&#x27;You are  &#x27;</span> . (count(<span class="variable">$clients</span>) - <span class="number">1</span>) . <span class="string">&quot;  clients connect\r\n&quot;</span>);</span><br><span class="line">            socket_getpeername(<span class="variable">$socket2</span>, <span class="variable">$ip</span>, <span class="variable">$port</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\nnew client[&quot;</span> . <span class="variable">$ip</span> . <span class="string">&quot;:&quot;</span> . <span class="variable">$port</span> . <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">            <span class="variable">$key</span> = array_search(<span class="variable">$socket1</span>, <span class="variable">$read</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$read</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$read</span> <span class="keyword">as</span> <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                <span class="comment">//读取客户端发来的数据</span></span><br><span class="line">                <span class="comment">//$msg = socket_read($socket_item, 1024);</span></span><br><span class="line">                <span class="variable">$result</span> = socket_recv(<span class="variable">$socket_item</span>, <span class="variable">$msg</span>, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="comment">//no data 客户端未发来消息</span></span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;no data&quot;</span> . PHP_EOL;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="variable">$result</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//socket closed 客户端断开</span></span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>); <span class="comment">//关闭服务器的socket</span></span><br><span class="line">                    <span class="comment">//清理已关闭的连接消息</span></span><br><span class="line">                    <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                    <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;client [<span class="subst">$socket_item</span>] is closed!\n&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;Server receive success [&quot;</span> . <span class="variable">$msg</span> . <span class="string">&quot;]&quot;</span> . time() . PHP_EOL;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$clients</span> <span class="keyword">as</span> <span class="variable">$client_socket</span>) &#123;</span><br><span class="line">                    <span class="comment">//发给别人（除去监听和自己）</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$client_socket</span> != <span class="variable">$socket1</span> &amp;&amp; <span class="variable">$client_socket</span> != <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                        sleep(<span class="number">1</span>);</span><br><span class="line">                        <span class="comment">//socket_write($client_socket, $msg, strlen($msg));</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$client_socket</span>, <span class="variable">$msg</span>, strlen(<span class="variable">$msg</span>))) &#123;</span><br><span class="line">                            socket_close(<span class="variable">$client_socket</span>);</span><br><span class="line">                            <span class="variable">$key1</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$read</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                            <span class="variable">$key2</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$clients</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&quot;otherclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>变化是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$msg</span> = @socket_read(<span class="variable">$socket_item</span>, <span class="number">1024</span>)) &#123;</span><br><span class="line">                   socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                   <span class="variable">$key</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                   <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">                   <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key</span>]);</span><br><span class="line">                   <span class="keyword">echo</span> <span class="string">&quot;READ ERROR client <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">               <span class="comment">//发给自己：$socket_item</span></span><br><span class="line">               <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$socket_item</span>, <span class="string">&#x27;I post : &#x27;</span> . <span class="variable">$msg</span>)) &#123;</span><br><span class="line">                   socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                   <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                   <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                   <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                   <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                   <span class="keyword">echo</span> <span class="string">&quot;MYclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                   <span class="keyword">continue</span>;</span><br><span class="line">               &#125;</span><br></pre></td></tr></table></figure>

<p>变成了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$result</span> = socket_recv(<span class="variable">$socket_item</span>, <span class="variable">$msg</span>, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="comment">//no data 客户端未发来消息</span></span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;no data&quot;</span> . PHP_EOL;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="variable">$result</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//socket closed 客户端断开</span></span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>); <span class="comment">//关闭服务器的socket</span></span><br><span class="line">                    <span class="comment">//清理已关闭的连接消息</span></span><br><span class="line">                    <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                    <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;client [<span class="subst">$socket_item</span>] is closed!\n&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;Server receive success [&quot;</span> . <span class="variable">$msg</span> . <span class="string">&quot;]&quot;</span> . time() . PHP_EOL;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>



<p>发现失去了查看自己发送的消息的功能，我又给加上了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * AF_INET    IPv4网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_INET6   IPv6网络协议，TCP和UDP都可用此协议</span></span><br><span class="line"><span class="comment"> * AF_UNIX    本地通讯协议，具有高性能和低成本的IPC（进程间通讯）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOCK_STREAM TCP协议套接字</span></span><br><span class="line"><span class="comment"> * SOCK_DGRAM  UDP协议套接字</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * SOL_TCP     TCP协议</span></span><br><span class="line"><span class="comment"> * SOL_UDP     UDP协议</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6004</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$clients</span> = <span class="keyword">array</span>(<span class="variable">$socket1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">//socket_select对读写套接字的数字是引用，为了保证clients不被改变，拷贝一份</span></span><br><span class="line">    <span class="variable">$read</span> = <span class="variable">$clients</span>;</span><br><span class="line">    <span class="variable">$write</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$except</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*当read发生变化，说明：有客户端进行连接操作了，</span></span><br><span class="line"><span class="comment">    $write和$except均为null，所以只检测read数组的变化</span></span><br><span class="line"><span class="comment">    socket_select的第四个参数null,表示阻塞，它会阻塞一直到发生变化，</span></span><br><span class="line"><span class="comment">                    0，表示为非阻塞，调用socket_select()后，立即返回，然后继续调用socket_select()不断循环</span></span><br><span class="line"><span class="comment">    返回值是修改后的数组中包含套接字资源的数量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (socket_select(<span class="variable">$read</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*socket_select 接受三个套接字数组，分别检查数组中的套接字是否处于可以操作的状态(返回时只保留可操作的套接字)</span></span><br><span class="line"><span class="comment">        使用最多的是 $read，因此以读为例,在套接字数组 $read 中最初应保有一个服务端监听套接字,每当该套接字可读时，就表示有一个用户发起了连接。此时你需要对该连接创建一个套接字，并加入到 $read 数组中</span></span><br><span class="line"><span class="comment">        当然，并不只是服务端监听的套接字会变成可读的，用户套接字也会变成可读的，此时你就可以读取用户发来的数据了</span></span><br><span class="line"><span class="comment">        socket_select 只在套接字数组发生了变化时才返回。也就是说，一旦执行到 socket_select 的下一条语句，则必有一个套接字是需要你操作的*/</span></span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="variable">$socket1</span>, <span class="variable">$read</span>)) &#123;</span><br><span class="line">            <span class="comment">//socket2负责处理通信（接收、发送）</span></span><br><span class="line">            <span class="variable">$socket2</span> = socket_accept(<span class="variable">$socket1</span>);</span><br><span class="line">            <span class="variable">$clients</span>[] = <span class="variable">$socket2</span>;</span><br><span class="line">            socket_write(<span class="variable">$socket2</span>, <span class="string">&#x27;You are  &#x27;</span> . (count(<span class="variable">$clients</span>) - <span class="number">1</span>) . <span class="string">&quot;  clients connect\r\n&quot;</span>);</span><br><span class="line">            socket_getpeername(<span class="variable">$socket2</span>, <span class="variable">$ip</span>, <span class="variable">$port</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;\nnew client[&quot;</span> . <span class="variable">$ip</span> . <span class="string">&quot;:&quot;</span> . <span class="variable">$port</span> . <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">            <span class="variable">$key</span> = array_search(<span class="variable">$socket1</span>, <span class="variable">$read</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (count(<span class="variable">$read</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$read</span> <span class="keyword">as</span> <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                <span class="comment">//读取客户端发来的数据</span></span><br><span class="line">                <span class="comment">//$msg = socket_read($socket_item, 1024);</span></span><br><span class="line">                <span class="variable">$result</span> = socket_recv(<span class="variable">$socket_item</span>, <span class="variable">$msg</span>, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                    <span class="comment">//no data 客户端未发来消息</span></span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;no data&quot;</span> . PHP_EOL;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (<span class="variable">$result</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//socket closed 客户端断开</span></span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>); <span class="comment">//关闭服务器的socket</span></span><br><span class="line">                    <span class="comment">//清理已关闭的连接消息</span></span><br><span class="line">                    <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                    <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;client [<span class="subst">$socket_item</span>] is closed!\n&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;Server receive success [&quot;</span> . <span class="variable">$msg</span> . <span class="string">&quot;]&quot;</span> . time() . PHP_EOL;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$socket_item</span>, <span class="string">&#x27;I post : &#x27;</span> . <span class="variable">$msg</span>)) &#123;</span><br><span class="line">                        socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                        <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                        <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                        <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;MYclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">foreach</span> (<span class="variable">$clients</span> <span class="keyword">as</span> <span class="variable">$client_socket</span>) &#123;</span><br><span class="line">                    <span class="comment">//发给别人（除去监听和自己）</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="variable">$client_socket</span> != <span class="variable">$socket1</span> &amp;&amp; <span class="variable">$client_socket</span> != <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">                        sleep(<span class="number">1</span>);</span><br><span class="line">                        <span class="comment">//socket_write($client_socket, $msg, strlen($msg));</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$client_socket</span>, <span class="variable">$msg</span>, strlen(<span class="variable">$msg</span>))) &#123;</span><br><span class="line">                            socket_close(<span class="variable">$client_socket</span>);</span><br><span class="line">                            <span class="variable">$key1</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$read</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                            <span class="variable">$key2</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$clients</span>);</span><br><span class="line">                            <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                            <span class="keyword">echo</span> <span class="string">&quot;otherclient <span class="subst">$key</span> is closed!\n&quot;</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="websocket05-php"><a href="#websocket05-php" class="headerlink" title="websocket05.php"></a>websocket05.php</h2><p>解决了php socket通信的诸多问题，我们现在来完成websocket聊天室雏形！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws=new WebSocket(&#x27;ws://192.168.10.106:6006&#x27;);</span><br><span class="line">ws.onmessage=function(msg)&#123;console.log(msg.data)&#125;;</span><br><span class="line">ws.send(&#x27;hello world!!&#x27;);</span><br></pre></td></tr></table></figure>

<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202307160152408.webp" alt="image-20230716015221722"></p>
<p>服务端代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$socket1</span> = socket_create(AF_INET, SOCK_STREAM, SOL_TCP);</span><br><span class="line">socket_bind(<span class="variable">$socket1</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">6006</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//socket1 负责监听</span></span><br><span class="line">socket_listen(<span class="variable">$socket1</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$clients</span> = <span class="keyword">array</span>(<span class="variable">$socket1</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">//socket_select对读写套接字的数字是引用，为了保证clients不被改变，拷贝一份</span></span><br><span class="line">    <span class="variable">$read</span> = <span class="variable">$clients</span>;</span><br><span class="line">    <span class="variable">$write</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$except</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (socket_select(<span class="variable">$read</span>, <span class="variable">$write</span>, <span class="variable">$except</span>, <span class="literal">null</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$read</span> <span class="keyword">as</span> <span class="variable">$socket_item</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$socket_item</span> == <span class="variable">$socket1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="variable">$socket_client</span> = socket_accept(<span class="variable">$socket_item</span>)) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="variable">$hello</span> = @socket_read(<span class="variable">$socket_client</span>, <span class="number">1024</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$hello</span> === <span class="literal">false</span>) &#123;</span><br><span class="line">                    socket_close(<span class="variable">$socket_client</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                handshake(<span class="variable">$hello</span>, <span class="variable">$socket_client</span>);</span><br><span class="line">                socket_getpeername(<span class="variable">$socket_client</span>, <span class="variable">$ip</span>, <span class="variable">$port</span>);</span><br><span class="line">                <span class="variable">$clients</span>[<span class="variable">$ip</span>.<span class="string">&quot;:&quot;</span>.<span class="variable">$port</span>] = <span class="variable">$socket_client</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;new client[&quot;</span>.<span class="variable">$ip</span>.<span class="string">&quot;:&quot;</span>.<span class="variable">$port</span>.<span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;hello msg [&quot;</span>.<span class="variable">$hello</span>.<span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$result</span> = @socket_recv(<span class="variable">$socket_item</span>, <span class="variable">$msg</span>, <span class="number">1024</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="literal">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable">$result</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                    socket_close(<span class="variable">$socket_item</span>);</span><br><span class="line">                    <span class="variable">$key1</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$read</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                    <span class="variable">$key2</span> = array_search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;client [<span class="subst">$socket_item</span>] is closed!\n&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$web_msg</span> = decode(<span class="variable">$msg</span>);</span><br><span class="line">                    <span class="variable">$id</span> = search(<span class="variable">$socket_item</span>, <span class="variable">$clients</span>);</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;client [&quot;</span> . <span class="variable">$id</span> . <span class="string">&quot;] say:&quot;</span> . <span class="variable">$web_msg</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                    <span class="variable">$broadcast</span> = encode(<span class="variable">$web_msg</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$clients</span> <span class="keyword">as</span> <span class="variable">$client_socket</span>) &#123;</span><br><span class="line">                        <span class="comment">//发给别人（除去监听和自己）</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="variable">$client_socket</span> != <span class="variable">$socket1</span>) &#123;</span><br><span class="line">                            <span class="comment">//socket_write($client_socket, $msg, strlen($msg));</span></span><br><span class="line">                            <span class="keyword">if</span> (<span class="literal">false</span> === @socket_write(<span class="variable">$client_socket</span>, <span class="variable">$broadcast</span>, strlen(<span class="variable">$broadcast</span>))) &#123;</span><br><span class="line">                                socket_close(<span class="variable">$client_socket</span>);</span><br><span class="line">                                <span class="variable">$key1</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$read</span>);</span><br><span class="line">                                <span class="keyword">unset</span>(<span class="variable">$read</span>[<span class="variable">$key1</span>]);</span><br><span class="line">                                <span class="variable">$key2</span> = array_search(<span class="variable">$client_socket</span>, <span class="variable">$clients</span>);</span><br><span class="line">                                <span class="keyword">unset</span>(<span class="variable">$clients</span>[<span class="variable">$key2</span>]);</span><br><span class="line">                                <span class="keyword">echo</span> <span class="string">&quot;otherclient [<span class="subst">$socket_item</span>] is closed!\n&quot;</span>;</span><br><span class="line">                            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                                <span class="keyword">echo</span> <span class="string">&#x27;消息已发送给&#x27;</span>.<span class="variable">$client_socket</span>.<span class="string">&quot;\n&quot;</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handshake</span>(<span class="params"><span class="variable">$buffer</span>, <span class="variable">$client_socket</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//截取Sec-WebSocket-Key的值并加密</span></span><br><span class="line">    <span class="variable">$temp_str</span> = substr(<span class="variable">$buffer</span>, strpos(<span class="variable">$buffer</span>, <span class="string">&#x27;Sec-WebSocket-Key&#x27;</span>) + <span class="number">18</span>);</span><br><span class="line">    <span class="variable">$client_key</span> = trim(substr(<span class="variable">$temp_str</span>, <span class="number">0</span>, strpos(<span class="variable">$temp_str</span>, <span class="string">&quot;\r\n&quot;</span>)));</span><br><span class="line">    <span class="variable">$server_key</span> = base64_encode(sha1(<span class="variable">$client_key</span> . <span class="string">&quot;258EAFA5-E914-47DA-95CA-C5AB0DC85B11&quot;</span>, <span class="literal">true</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;client_key[&#x27;</span> . <span class="variable">$client_key</span> . <span class="string">&quot;]\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;server_key[&#x27;</span> . <span class="variable">$server_key</span> . <span class="string">&quot;]\n\n&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$client_key</span> == <span class="string">&#x27;&#x27;</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是响应包内容，浏览器会进行验证，成功后会建立连接</span></span><br><span class="line">    <span class="variable">$handshake_msg</span> = <span class="string">&quot;HTTP/1.1 101 Switching Protocols\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span> .= <span class="string">&quot;Upgrade: websocket\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span> .= <span class="string">&quot;Sec-WebSocket-Version: 13\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span> .= <span class="string">&quot;Connection: Upgrade\r\n&quot;</span>;</span><br><span class="line">    <span class="variable">$handshake_msg</span> .= <span class="string">&quot;Sec-WebSocket-Accept: &quot;</span> . <span class="variable">$server_key</span> .<span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line">    socket_write(<span class="variable">$client_socket</span>, <span class="variable">$handshake_msg</span>, strlen(<span class="variable">$handshake_msg</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$handshake_msg</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//数据帧处理</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$len</span> = strlen(<span class="variable">$buffer</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x81&quot;</span> . chr(<span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$len</span> &lt;= <span class="number">65535</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x81&quot;</span> . chr(<span class="number">126</span>) . pack(<span class="string">&quot;n&quot;</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;\x81&quot;</span> . chr(<span class="number">127</span>) . pack(<span class="string">&quot;xxxxN&quot;</span>, <span class="variable">$len</span>) . <span class="variable">$buffer</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$buffer</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$len</span> = <span class="variable">$masks</span> = <span class="variable">$data</span> = <span class="variable">$decoded</span> = <span class="literal">null</span>;</span><br><span class="line">    <span class="variable">$len</span> = ord(<span class="variable">$buffer</span>[<span class="number">1</span>]) &amp; <span class="number">127</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">8</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$len</span> === <span class="number">127</span>) &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">14</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$masks</span> = substr(<span class="variable">$buffer</span>, <span class="number">2</span>, <span class="number">4</span>);</span><br><span class="line">        <span class="variable">$data</span> = substr(<span class="variable">$buffer</span>, <span class="number">6</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$index</span> = <span class="number">0</span>; <span class="variable">$index</span> &lt; strlen(<span class="variable">$data</span>); <span class="variable">$index</span>++) &#123;</span><br><span class="line">        <span class="variable">$decoded</span> .= <span class="variable">$data</span>[<span class="variable">$index</span>] ^ <span class="variable">$masks</span>[<span class="variable">$index</span> % <span class="number">4</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$decoded</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">search</span>(<span class="params"><span class="variable">$socket_client</span>, <span class="variable">$clients</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$search</span> = array_search(<span class="variable">$socket_client</span>, <span class="variable">$clients</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$search</span> === <span class="literal">null</span>) <span class="variable">$search</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$search</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面我们来搞一个客户端，主要就是javascript</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>socket<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;cc&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:500px;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;content&quot;</span> <span class="attr">style</span>=<span class="string">&quot; height:400px; overflow:auto; width:100%; border:1px solid #ccc;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;form&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;text&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%; height:200px;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ab();&quot;</span> <span class="attr">value</span>=<span class="string">&quot;发送&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;a&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-2.1.3.min.js&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> wsServer = <span class="string">&#x27;ws://192.168.111.1:6006&#x27;</span>;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">var</span> websocket = <span class="keyword">new</span> WebSocket(wsServer);</span></span><br><span class="line"><span class="javascript">  websocket.onopen = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&quot;Connected to WebSocket server.&quot;</span>);</span></span><br><span class="line"><span class="javascript">  &#125;;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">  websocket.onclose = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&quot;Disconnected&quot;</span>);</span></span><br><span class="line"><span class="javascript">  &#125;;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">  websocket.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">evt</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">&#x27;#content&#x27;</span>).append(evt.data+<span class="string">&quot;&lt;br&gt;&quot;</span>);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="comment">// document.getElementById(&#x27;div&#x27;).style.background = evt.data;</span></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&#x27;Retrieved data from server: &#x27;</span> + evt.data);</span></span><br><span class="line"><span class="javascript">  &#125;;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">  websocket.onerror = <span class="function"><span class="keyword">function</span> (<span class="params">evt, e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(<span class="string">&#x27;Error occured: &#x27;</span> + evt.data);</span></span><br><span class="line"><span class="javascript">  &#125;;</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="keyword">function</span> <span class="title">ab</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> zhi = $(<span class="string">&#x27;#text&#x27;</span>).val();</span></span><br><span class="line"><span class="javascript">    websocket.send(zhi);</span></span><br><span class="line"><span class="javascript">    $(<span class="string">&#x27;#text&#x27;</span>).val(<span class="string">&#x27;&#x27;</span>);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">  &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


















      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/07/15/7.29/python%E5%B9%B6%E5%8F%91/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>python并发详解</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/07/10/7.29/AWD%E5%B9%B3%E5%8F%B0/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      AWD平台搭建
    </a>
  
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              <div class="matts">安</div><div class="matts">得</div><div class="matts">倚</div><div class="matts">天</div><div class="matts">剑</div>
            </div>
          
            <div class="foot-line">
              <div class="matts">跨</div><div class="matts">海</div><div class="matts">斩</div><div class="matts">长</div><div class="matts">鲸</div>
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">朋友</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://blog.huamang.xyz/">huamang</a>
                  </div>
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/Aurora-M/">Aurora</a>
                  </div>
                
                <div class="text">
                  <img alt="link"
                       height="20px"
                       width="20px"
                       src="/images/icon/icon-link+.svg"/>
                  <a class="foot-link"
                     href="mailto:735587142@qq.com?subject=%E7%94%B3%E8%AF%B7%20Hozen.site%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  申请友链</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/MUNG29">github</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/QQ.png"/>
                    <a class="foot-link" href="">735587142</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link"
                     height="20px"
                     width="20px"
                     src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:735587142@qq.com">735587142@qq.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://MUNG29.github.io">东隅's blog</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)"
            d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)"
            d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)"
            d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    
  
  
    <script type="text/javascript" src=/js/toc.js></script>
  

  </body>
</html>
