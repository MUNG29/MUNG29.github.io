<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />
    <title>
      
        临时文件包含 | 东隅's blog
      
    </title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    
      <link rel="apple-touch-icon"
            sizes="180x180"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="32x32"
            href="/images/jocker.png"/>
    
    
      <link rel="icon"
            type="image/png"
            sizes="16x16"
            href="/images/jocker.png"/>
    
    
      <link rel="mask-icon"
            href="/images/jocker.png"
            color=""/>
    
    
    <link rel="stylesheet" type="text/css" href="/css/layout.css"/>
    
    
  <link rel="stylesheet" type="text/css" href="/css/post.css"/>
  

  <meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <div class="head">
      <div class="nav">
        <a href="/" class="nav-logo">
          <img alt="logo" height="60px" width="60px" src="/images/jocker.png" />
        </a>
        <input id="navBtn" type="checkbox"/>
        <div class="nav-menu">
          
            
              <a class="nav-menu-item" href="/%E5%AE%89%E5%85%A8">安全</a>
            
              <a class="nav-menu-item" href="/%E5%BC%80%E5%8F%91">开发</a>
            
              <a class="nav-menu-item" href="/%E7%94%9F%E6%B4%BB">生活</a>
            
          
        </div>
        <label class="nav-btn" for="navBtn"></label>
      </div>
    </div>
    <div class="body">
      
  <article class="post-content">
    <div class="post-inner">
      <div class="post-content__head">
        <div class="post-title">临时文件包含</div>
        <div class="post-info">
          
  
    <a href="/tags/OWASP/" class="post-tag">#OWASP</a>
  
    <a href="/tags/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/" class="post-tag">#文件包含</a>
  


          <span class="post-date">2023-06-20</span>
        </div>
      </div>
      <div id="postBody" class="post-content__body--toc">
        <div id="tocAnchor" class="toc-anchor">
          <ol id="toc" class="post-toc">
            
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86"><span class="toc-text">认识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E7%9B%AE%E5%BD%95"><span class="toc-text">存储目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99"><span class="toc-text">命名规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E6%B4%BB%E5%91%A8%E6%9C%9F"><span class="toc-text">存活周期</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8%EF%BC%9F"><span class="toc-text">如何利用？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80%EF%BC%9A%E5%A6%82%E4%BD%95%E8%83%BD%E5%A4%9F%E8%AE%BF%E9%97%AE%E5%88%B0%E8%AF%A5%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%EF%BC%9F"><span class="toc-text">问题一：如何能够访问到该临时文件？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C%EF%BC%9A%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%87%E4%BB%B6%E5%90%8D%EF%BC%9F"><span class="toc-text">问题二：如何获得临时文件的文件名？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8php%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4%E5%86%85%E5%8C%85%E5%90%AB%E5%88%B0%E8%AF%A5%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%EF%BC%9F"><span class="toc-text">如何在php运行时间内包含到该临时文件？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#session"><span class="toc-text">session</span></a></li></ol>
            
          </ol>
        </div>
        
          <div class="post-gallery">
            
          </div>
        
        <p>讲到临时文件，中心就是在/tmp目录，主要有两方面，一是session临时文件，二是文件上传的临时文件</p>
<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h2 id="认识"><a href="#认识" class="headerlink" title="认识"></a>认识</h2><p>文件上传以后会在临时存储目录下生成文件名为php**.tmp的文件，而且该文件内容就是上传的内容</p>
<p>==php文件上传==</p>
<blockquote>
<p>上传后会文件会保存在全局变量$_FILES里，该数组包含了所有上传文件的文件信息。</p>
<ol>
<li>$_FILES[‘userfile’][‘name’] 客户端文件的原名称。</li>
<li>$_FILES[‘userfile’][‘type’] 文件的 MIME 类型，如果浏览器提供该信息的支持，例如”image/gif”。</li>
<li>$_FILES[‘userfile’][‘size’] 已上传文件的大小，单位为字节。</li>
<li>$_FILES[‘userfile’][‘tmp_name’] 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，默认是/tmp目录。</li>
<li>$_FILES[‘userfile’][‘error’] 该文件上传的错误代码，上传成功其值为0，否则为错误信息。</li>
<li>$_FILES[‘userfile’][‘tmp_name’] 文件被上传后在服务端存储的临时文件名</li>
</ol>
<p>这里的重点就是**$_FILES[‘userfile’][‘tmp_name’]** 这个变量。</p>
</blockquote>
<h3 id="存储目录"><a href="#存储目录" class="headerlink" title="存储目录"></a>存储目录</h3><p>文件被上传后，默认会被存储到服务端的默认临时目录中，该临时目录由<strong>php.ini</strong>的<strong>upload_tmp_dir</strong>属性指定，假如<strong>upload_tmp_dir</strong>的路径不可写，PHP会上传到系统默认的临时目录中，假如开启了<strong>open_basedir</strong>，要想成功上传，系统默认临时目录需要指定PHP可访问。</p>
<h3 id="命名规则"><a href="#命名规则" class="headerlink" title="命名规则"></a>命名规则</h3><p>在上传存储到临时目录后，<strong>临时文件命名的规则如下</strong>:</p>
<p>默认为 php+4或者6位随机数字和大小写字母</p>
<p>php[0-9A-Za-z]{3,4,5,6}</p>
<p>比如 ：phpXXXXXX.tmp 在windows下有tmp后缀，linux没有。</p>
<h3 id="存活周期"><a href="#存活周期" class="headerlink" title="存活周期"></a>存活周期</h3><p><img src="https://my-pic-1309722427.cos.ap-nanjing.myqcloud.com/img/202306210125875.webp" alt="image-20230621012509546"></p>
<p>上面这张图是PHP在通过POST方法上传文件时的运行周期图，可以看到我们临时文件的存活周期就是上图红色框中的时间段。另外，如果在php运行的过程中，假如php非正常结束，比如崩溃，那么这个临时文件就会==永久的保留==。如果php正常的结束，并且该文件没有被移动到其它地方也没有被改名，则该文件将在表单==请求结束时被删除==。</p>
<h2 id="如何利用？"><a href="#如何利用？" class="headerlink" title="如何利用？"></a>如何利用？</h2><p>既然了解了PHP上传会产生临时文件，并且文件内容可控，那我们就不禁要思考思考，这里有没有存在可以利用的点呢？</p>
<p>这就有以下几个问题：</p>
<h3 id="问题一：如何能够访问到该临时文件？"><a href="#问题一：如何能够访问到该临时文件？" class="headerlink" title="问题一：如何能够访问到该临时文件？"></a>问题一：如何能够访问到该临时文件？</h3><p>由于临时文件目录一般不可访问，因此想要利用临时文件一般需要配合文件包含，或者某些ssrf结合包含来进行利用。</p>
<h3 id="问题二：如何获得临时文件的文件名？"><a href="#问题二：如何获得临时文件的文件名？" class="headerlink" title="问题二：如何获得临时文件的文件名？"></a>问题二：如何获得临时文件的文件名？</h3><p>1.在前面介绍过临时文件的命名规则，因此，当我们获得了一个文件包含点时，可以通过暴力猜解文件名来得到。这时最朴素，最笨拙的方法，但也是最有效的方法。</p>
<p>2.在windows中，利用了FindFirstFile方法，可以通过通配符来进行文件包含，在linux中也有相应的一些方法。</p>
<p>3.第三种方法就是通过**/proc/self/fd/xxx**来获得，xxx从10开始，这里获得的时当前运行进程ID的一些符号链接，这个方式的有效性取决于上传文件的大小，大文件可以增加尝试的时间。</p>
<p>获得文件名的方法应该有很多，这里只列举最笨拙的几种</p>
<h3 id="如何在php运行时间内包含到该临时文件？"><a href="#如何在php运行时间内包含到该临时文件？" class="headerlink" title="如何在php运行时间内包含到该临时文件？"></a>如何在php运行时间内包含到该临时文件？</h3><p>1.本地文件包含可以让php<strong>包含自身</strong>从而导致死循环，然后php守护进程产生内存溢出，然后php会崩溃，php自身是不会因为错误直接退出的，它会清空自己的内存堆栈，以便从错误中恢复，这就保证了web服务的正常运转的同时，打断了php对临时文件的处理，在这个时候对任一php文件进行post文件请求，临时文件就会被保留。</p>
<p>正常的执行流程应该如下图所示：</p>
<p><img src="https://p3.ssl.qhimg.com/t01610a5c5cd09be792.png" alt="正常执行流程"></p>
<p>而在漏洞利用过程中：</p>
<p><img src="https://p3.ssl.qhimg.com/t01aa94dbe78929b207.png" alt="漏洞利用流程"></p>
<p>因此临时目录下的临时文件有部分得以保存，再通过包含这部分文件即可getshell。</p>
<p>在实际测试过程中，我使用wamp分别测试了版本是7.2.14和7.1.26和7.0.33和5.6.40的php，利用这个方法可以使临时文件存在时间延长到5s，但是最后还是会删除，但是在5.5.9等比较旧的版本是可以成功的，在这些高版本中，如果能在这5s内包含到文件也算是成功利用，不过这难度太大，如果有好的思路希望可以交流。</p>
<p>新起一个docker（php:apache） ，版本就是latest的，尝试适用多线程去跑，开了50个线程</p>
<p><img src="https://p3.ssl.qhimg.com/t015c3f9e44e301e1cf.png" alt="burp利用"></p>
<p>payload选择null payloads并选择持续的跑，跑了一段时间之后就可以停止了。</p>
<p><img src="https://p0.ssl.qhimg.com/t011d35a9a4aec26f68.png" alt="null payload"></p>
<p>在docker中观察，如果一直开着，临时文件始终保持50个，停止之后，临时文件奇怪的先增加了，然后又减少，一直到最后，有部分文件被保存了下来，回想起前面说的，php只有正常结束临时文件才会清除，因此这可能跟配置有关，比如一大堆的请求阻塞着，最后某些线程崩溃，导致部分文件被驻留在tmp目录，笔者自身对怎么调试php不太熟悉，因此这个先增加后减少的具体原因还不确定。</p>
<p><img src="https://p5.ssl.qhimg.com/t01e829ead3c64bb8ca.png" alt="运行结果1"></p>
<p>这个时候就可以跑脚本来爆破文件名，为了不占字数，我把脚本都放在文末的附录中，这里要注意有可能因为前面访问次数太频繁而被禁止访问出现Max retries exceeded with url错误，需要更换代理来爆破文件名，或者捕获Connection error来进行处理。</p>
<p>2.根据@王一航师傅去年的一个发现，利用<strong>php://filter/string.strip_tags</strong>造成崩溃。在含有文件包含漏洞的地方，使用<strong>php://filter/string.strip_tags</strong>导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell，这个崩溃原因是存在一处空指针引用。根据师傅所说这个点只在php7.2以下存在，我把大部分的版本都测了一下。</p>
<p>经过测试，该方法仅适用于以下php7版本，php5并不存在该崩溃：</p>
<p>• php7.0.0-7.1.2可以利用， 7.1.2x版本的已被修复</p>
<p>• php7.1.3-7.2.1可以利用， 7.2.1x版本的已被修复</p>
<p>• php7.2.2-7.2.8可以利用， 7.2.9一直到7.3到现在的版本已被修复</p>
<p><img src="https://p1.ssl.qhimg.com/t0127627cba59877667.png" alt="php崩溃清空"></p>
<p>临时文件由于崩溃成功保留下来</p>
<p><img src="https://p1.ssl.qhimg.com/t011f7c24b84edf89a1.png" alt="运行结果2"></p>
<p>3.利用wupco师傅发现的**filter:<code>convert.quoted-printable-encode</code>**导致的segment fault。实际上，这个崩溃并不适用于include，require等函数，经过测试，该方法适用于以下版本（201812月以前的版本，由于师傅提交了因此之后的版本修复了，tql）的以下函数（file函数，file_get_contents函数，readfile函数）：</p>
<p>• php7.0.0-7.0.32</p>
<p>• php7.0.4-7.2.12</p>
<p>• php&lt;=5.6.38的版本</p>
<p>这里要说明下5.6.39-5.6.9以内的版本并不存在这个崩溃</p>
<p><img src="https://p1.ssl.qhimg.com/t01436b559f31baad80.png" alt="file_get_content"></p>
<p>在这里介绍的三种方式中，自包含是最不稳定的而且经常阻塞服务器，第二第三种只要符合特定版本，就可以稳定利用，最后爆破文件名来利用。</p>
<h1 id="session"><a href="#session" class="headerlink" title="session"></a>session</h1>
      </div>
    </div>
  </article>
  <div class="post__foot">
    
    <div class="post-nav">
  
    <a class="post-nav-item-left" href="/2023/06/21/7.29/%E6%97%A0%E5%8F%82%E6%95%B0rce/">
      <div class="text-align">
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
        <span class="text-small">上一篇</span>
      </div>
      <div>php无参数rce</div>
    </a>
  
  <div class="vhr"></div>
  
    <a class="post-nav-item-right" href="/2023/06/19/mysql8%E6%96%B0%E7%89%B9%E6%80%A7/">
      <div class="text-align">
        <span class="text-small">下一篇</span>
        <svg t="1670570876164"
             class="icon"
             viewBox="0 0 1024 1024"
             transform="scale(-1,-1)"
             width="16"
             height="16">
          <path d="M384 512L731.733333 202.666667c17.066667-14.933333 19.2-42.666667 4.266667-59.733334-14.933333-17.066667-42.666667-19.2-59.733333-4.266666l-384 341.333333c-10.666667 8.533333-14.933333 19.2-14.933334 32s4.266667 23.466667 14.933334 32l384 341.333333c8.533333 6.4 19.2 10.666667 27.733333 10.666667 12.8 0 23.466667-4.266667 32-14.933333 14.933333-17.066667 14.933333-44.8-4.266667-59.733334L384 512z" p-id="14596"/>
        </svg>
      </div>
      mysql8新特性
    </a>
  
</div>

    
    
  </div>

    </div>
    <div class="foot">
      <div class="foot-inner">
        <div class="foot__head">
          
            <div class="foot-line">
              <div class="matts">安</div><div class="matts">得</div><div class="matts">倚</div><div class="matts">天</div><div class="matts">剑</div>
            </div>
          
            <div class="foot-line">
              <div class="matts">跨</div><div class="matts">海</div><div class="matts">斩</div><div class="matts">长</div><div class="matts">鲸</div>
            </div>
          
        </div>
        <div class="foot__body">
          
            <div class="foot-item">
              <div class="foot-item__head">朋友</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://blog.huamang.xyz/">huamang</a>
                  </div>
                
                  <div class="text">
                    <img alt="link"
                         height="20px"
                         width="20px"
                         src="/images/icon/icon-link.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://www.cnblogs.com/Aurora-M/">Aurora</a>
                  </div>
                
                <div class="text">
                  <img alt="link"
                       height="20px"
                       width="20px"
                       src="/images/icon/icon-link+.svg"/>
                  <a class="foot-link"
                     href="mailto:735587142@qq.com?subject=%E7%94%B3%E8%AF%B7%20Hozen.site%20%E7%9A%84%E5%8F%8B%E9%93%BE%E4%BD%8D%E7%BD%AE">
                  申请友链</a>
                </div>
              </div>
            </div>
          
          
            <div class="foot-item">
              <div class="foot-item__head">账号</div>
              <div class="foot-item__body">
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/logo-github.svg"/>
                    <a class="foot-link" target="_blank" rel="noopener" href="https://github.com/MUNG29">github</a>
                  </div>
                
                  <div class="text">
                    <img alt="link" height="20px" width="20px" src="/images/QQ.png"/>
                    <a class="foot-link" href="">735587142</a>
                  </div>
                
              </div>
            </div>
          
          <div class="foot-item">
            <div class="foot-item__head">联系</div>
            <div class="foot-item__body">
              <div class="text">
                <img alt="link"
                     height="20px"
                     width="20px"
                     src="/images/icon/icon-email.svg"/>
                <a class="foot-link" href="mailto:735587142@qq.com">735587142@qq.com</a>
              </div>
            </div>
          </div>
        </div>
        <div class="copyright">
          <a href="https://MUNG29.github.io">东隅's blog</a> &nbsp;|&nbsp;由&nbsp;<a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>&nbsp;及&nbsp;
          <svg width="20" height="20" viewBox="0 0 725 725">
            <path fill-rule="evenodd" fill="rgb(221, 221, 221)"
            d="M145.870,236.632 L396.955,103.578 L431.292,419.44 L156.600,522.53 L145.870,236.632 Z" />
            <path fill-rule="evenodd" fill="rgb(159, 159, 159)"
            d="M396.955,103.578 L564.345,234.486 L611.558,513.469 L431.292,419.44 L396.955,103.578 Z" />
            <path fill-rule="evenodd" fill="rgb(0, 0, 0)"
            d="M431.292,419.44 L611.558,513.469 L358.327,595.18 L156.600,522.53 L431.292,419.44 Z" />
          </svg>
          <a target="_blank" rel="noopener" href="https://github.com/hooozen/hexo-theme-tranquility">致远</a>&nbsp;驱动
        </div>
      </div>
    </div>
    
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    
  
  
    <script type="text/javascript" src=/js/toc.js></script>
  

  </body>
</html>
